  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Backend API URL - Railway deployment -->
  <meta name="api-base-url" content="https://ksystem-production.up.railway.app">
  <title>Admin Dashboard - Seoul Surplus</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="sales-notification-styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle menu">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
      <h2 class="logo">Super Admin Panel</h2>
      <nav>
        <ul>
          <li>
            <a href="#inventory" class="active">
              Inventory
              <span id="sidebar-low-stock-badge" class="sidebar-badge" style="display: none;">0</span>
            </a>
          </li>
          <li style="display: none;"><a href="#reservations">Reservations</a></li>
          <li><a href="#sales">Sales</a></li>
          <li><a href="#sales-entry">Sales Entry</a></li>
          <li style="display: none;"><a href="#customers">Customers</a></li>
          <li><a href="#product-history">Product History</a></li>
          <li><a href="#account-management">Account Management</a></li>
          <li><a href="#admin-profile">Profile</a></li>
          <li><a href="#" id="sidebar-logout-btn" data-action="logout">Logout</a></li>
        </ul>
      </nav>
    </aside>

  <!-- Main Content -->
  <main class="content">
    <div class="page-header">
      <div>
        <p class="greeting">Hello, <span id="current-user-name">Admin</span>!</p>
        <h1>Operations Control Center</h1>
        <p class="role-chip"><span id="current-user-role">Super Admin</span></p>
      </div>
      <div class="header-actions">
        <!-- Notification Bell -->
        <div class="notification-container">
          <button id="notification-bell" class="notification-bell" aria-label="Notifications">
            üîî
            <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
          </button>
          <div id="notification-dropdown" class="notification-dropdown" style="display: none;">
            <div class="notification-header">
              <h3>Notifications</h3>
              <div class="notification-header-actions">
                <button id="mute-notifications" class="mute-btn" title="Mute notifications" aria-label="Mute notifications">
                  üîï
                </button>
                <button id="close-notifications" class="close-btn">√ó</button>
              </div>
            </div>
            <div class="notification-tabs">
              <button class="notification-tab active" data-tab="low-stock">Low Stock</button>
              <button class="notification-tab" data-tab="sold">Sold Items</button>
            </div>
            <div id="notification-content" class="notification-content">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Inventory -->
    <section id="inventory" class="section active">
      <h1>Inventory</h1>
      <div id="inventory-restricted" class="alert" hidden>
        Access denied: This user cannot view the inventory.
      </div>
      
      <!-- Sales Notification Banner -->
      <div id="sales-notification-banner" class="sales-notification-banner" style="display: none;">
        <div class="alert-content">
          <div class="alert-icon">üí∞</div>
          <div class="alert-text">
            <strong>New Sale Confirmed!</strong>
            <span id="sales-notification-message">A product has been sold.</span>
            <a href="#sales-entry" class="alert-link">View Sales ‚Üí</a>
          </div>
          <button class="alert-close" onclick="document.getElementById('sales-notification-banner').style.display='none'">√ó</button>
        </div>
      </div>
      
      <!-- Low Stock Alert Banner -->
      <div id="low-stock-alert-banner" class="low-stock-alert-banner" style="display: none;">
        <div class="alert-content">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div class="alert-text">
            <strong>Low Stock Alert!</strong>
            <span id="low-stock-count">0</span> product(s) are running low on inventory.
            <a href="#low-stock-section" class="alert-link">View Details ‚Üí</a>
          </div>
          <button class="alert-close" onclick="document.getElementById('low-stock-alert-banner').style.display='none'">√ó</button>
        </div>
      </div>
      
      <div class="inventory-actions">
        <button id="export-csv-btn" class="btn">Export to CSV/Excel</button>
        <button id="add-product-btn" class="btn btn-success">Add New Product</button>
      </div>
      <div id="inventory-unsaved-banner" class="unsaved-banner" hidden>
        Unsaved changes detected. Please save each product update before leaving this page.
      </div>

      <!-- Add Product Modal -->
      <div id="add-product-modal" class="modal" style="display: none;">
        <div class="modal-content" id="add-product-modal-content">
          <div class="modal-header" id="add-product-modal-header">
            <h2>Add New Product</h2>
            <span class="close" id="close-modal">&times;</span>
          </div>
          <form id="add-product-form" class="modal-body">
            <div class="form-group">
              <label for="product-name">Product Name:</label>
              <input type="text" id="product-name" required>
            </div>
            <div class="form-group">
              <label for="product-brand">Brand:</label>
              <input type="text" id="product-brand" list="brand-list" placeholder="Enter or select brand name" autocomplete="off" required>
              <datalist id="brand-list"></datalist>
            </div>
            <div class="form-group">
              <label for="product-category">Category:</label>
              <input type="text" id="product-category" list="category-list" placeholder="Enter or select category name" autocomplete="off" required>
              <datalist id="category-list"></datalist>
            </div>
            <div class="form-group">
              <label for="product-size">Size: <span style="color: #6b7280; font-weight: normal;">(Optional)</span></label>
              <select id="product-size">
                <option value="">Select size (Optional)</option>
                <option value="Extra Small">Extra Small</option>
                <option value="Small">Small</option>
                <option value="Medium">Medium</option>
                <option value="Large">Large</option>
                <option value="Extra Large">Extra Large</option>
              </select>
            </div>
            <div class="form-group">
              <label for="product-condition">Condition:</label>
              <select id="product-condition" required>
                <option value="New">New</option>
                <option value="Like New">Like New</option>
                <option value="Good">Good</option>
                <option value="Fair">Fair</option>
              </select>
            </div>
            <div class="form-group">
              <label for="product-price">Price (‚Ç±):</label>
              <input type="number" id="product-price" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="product-wholesale-price">Wholesale Price (‚Ç±):</label>
              <input type="number" id="product-wholesale-price" step="0.01" placeholder="Optional">
              <small class="text-muted">Set the wholesale price for this product</small>
            </div>
            <div class="form-group">
              <label for="product-stock">Stock Quantity:</label>
              <input type="number" id="product-stock" min="0" required>
            </div>
            <div class="form-group">
              <label for="product-low-stock-threshold">Low Stock Threshold:</label>
              <input type="number" id="product-low-stock-threshold" min="0" value="5" required>
              <small class="text-muted">Alert when stock falls below this quantity</small>
            </div>
            <div class="form-group">
              <label for="product-image">Product Image:</label>
              <div class="image-upload-options">
                <button type="button" class="btn btn-secondary" id="choose-file-btn" style="margin-right: 8px;">
                  <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  Choose File
                </button>
                <button type="button" class="btn btn-secondary" id="camera-btn">
                  <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                  Take Photo
                </button>
              </div>
              <input type="file" id="product-image" accept="image/*" required style="display: none;">
              <div id="image-preview" class="image-preview"></div>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">Add Product</button>
              <button type="button" class="btn btn-secondary" id="cancel-add">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Edit Product Modal -->
      <div id="edit-product-modal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Edit Product</h2>
            <span class="close" id="close-edit-modal">&times;</span>
          </div>
          <form id="edit-product-form" class="modal-body">
            <input type="hidden" id="edit-product-id">
            <div class="form-group">
              <label for="edit-product-name">Product Name:</label>
              <input type="text" id="edit-product-name" required>
            </div>
            <div class="form-group">
              <label for="edit-product-brand">Brand:</label>
              <input type="text" id="edit-product-brand" list="edit-brand-list" placeholder="Enter or select brand name" autocomplete="off" required>
              <datalist id="edit-brand-list"></datalist>
            </div>
            <div class="form-group">
              <label for="edit-product-category">Category:</label>
              <select id="edit-product-category" required>
                <option value="">Select category</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-product-size">Size: <span style="color: #6b7280; font-weight: normal;">(Optional)</span></label>
              <select id="edit-product-size">
                <option value="">Select size (Optional)</option>
                <option value="Extra Small">Extra Small</option>
                <option value="Small">Small</option>
                <option value="Medium">Medium</option>
                <option value="Large">Large</option>
                <option value="Extra Large">Extra Large</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-product-condition">Condition:</label>
              <select id="edit-product-condition" required>
                <option value="New">New</option>
                <option value="Like New">Like New</option>
                <option value="Good">Good</option>
                <option value="Fair">Fair</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-product-price">Price (‚Ç±):</label>
              <input type="number" id="edit-product-price" step="0.01" required>
            </div>
            <div class="form-group">
              <label for="edit-product-wholesale-price">Wholesale Price (‚Ç±):</label>
              <input type="number" id="edit-product-wholesale-price" step="0.01" placeholder="Optional">
              <small class="text-muted">Set the wholesale price for this product</small>
            </div>
            <div class="form-group" style="display: none;">
              <label for="edit-product-stock">Stock Quantity:</label>
              <input type="number" id="edit-product-stock" min="0" step="1" required>
              <small class="text-muted" style="color: #6b7280; font-style: italic;">Stock quantity can only be changed using the Save button in the inventory table</small>
            </div>
            <div class="form-group">
              <label for="edit-product-low-stock-threshold">Low Stock Threshold:</label>
              <input type="number" id="edit-product-low-stock-threshold" min="0" step="1" required>
              <small class="text-muted">Alert when stock falls below this quantity</small>
            </div>
            <div class="form-group">
              <label for="edit-product-image">Product Image:</label>
              <div class="image-upload-options">
                <button type="button" class="btn btn-secondary" id="edit-choose-file-btn" style="margin-right: 8px;">
                  <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  Choose File
                </button>
                <button type="button" class="btn btn-secondary" id="edit-camera-btn">
                  <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                  Take Photo
                </button>
              </div>
              <input type="file" id="edit-product-image" accept="image/*" style="display: none;">
              <div id="edit-image-preview" class="image-preview"></div>
              <p style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;">Upload a JPG, PNG, or other image file. The image will be stored in the database.</p>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">Update Product</button>
              <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      <div class="cards">
        <div class="card">Total Products: <span id="total-products-count">0</span></div>
        <div class="card">Inventory Value: <span id="inventory-value">‚Ç±0</span></div>
        <div class="card low-stock-card">
          <span>Low Stock Items: <span id="low-stock-items-count" class="low-stock-badge">0</span></span>
        </div>
        <div class="card">Sales Today: <span id="sales-today-count">‚Ç±0.00</span></div>
      </div>

      <!-- Low Stock Items Section -->
      <div id="low-stock-section" class="low-stock-section" style="display: none;">
        <div class="section-header-with-action">
          <h2>‚ö†Ô∏è Low Stock Items Requiring Attention</h2>
          <button id="dismiss-low-stock-btn" class="btn btn-secondary">Dismiss</button>
        </div>
        <div class="low-stock-items-grid" id="low-stock-items-grid">
          <!-- Low stock items will be displayed here -->
        </div>
      </div>

      <h2>Product List</h2>
      
      <!-- Search and Filter Controls -->
      <div class="product-filters">
        <div class="product-search-wrapper">
          <input type="text" id="product-search" placeholder="üîç Search products by name or brand...">
        </div>
        <div class="product-category-wrapper">
          <select id="product-category-filter">
            <option value="">All Categories</option>
          </select>
        </div>
      </div>
      <div class="inventory-table-wrapper">
        <table id="inventory-table">
        <thead>
          <tr>
            <th style="width: 100px;">Product Image</th>
            <th style="width: 200px;">Product Name</th>
            <th style="width: 150px;">Quantity</th>
            <th style="width: 120px;">Stock Status</th>
            <th style="width: 120px;">Retail Price</th>
            <th style="width: 120px;">Wholesale Price</th>
            <th style="width: 150px;">Actions</th>
          </tr>
        </thead>
        <tbody id="inventory-table-body">
          <!-- Products will be loaded here -->
        </tbody>
      </table>
      </div>
    </section>

    <!-- Logout Confirmation Modal -->
    <div id="logout-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 420px;">
        <div class="modal-header" style="border-bottom: 1px solid #e5e7eb; padding-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <span style="font-size: 24px;">üö™</span>
        </div>
            <div>
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111827;">Confirm Logout</h2>
              <p style="margin: 4px 0 0 0; font-size: 0.875rem; color: #6b7280;">You're about to sign out</p>
          </div>
        </div>
          <span class="close" id="close-logout-modal" style="font-size: 24px; color: #9ca3af; cursor: pointer; transition: color 0.2s;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <div style="text-align: center; margin-bottom: 24px;">
            <p style="margin: 0 0 8px 0; color: #374151; font-size: 1rem; line-height: 1.5;">
              Are you sure you want to logout from your account?
            </p>
            <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
              You'll need to sign in again to access the dashboard.
            </p>
          </div>
          <div class="form-actions" style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
            <button type="button" class="btn btn-secondary" id="cancel-logout" style="flex: 1 1 100%; padding: 12px 24px; font-weight: 500; border-radius: 8px; transition: all 0.2s;">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-logout" style="flex: 1 1 100%; padding: 12px 24px; font-weight: 500; border-radius: 8px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); transition: all 0.2s;">Logout</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Switch Admin Account Confirmation Modal -->
    <div id="switch-admin-modal" class="modal" style="display: none;">
      <div class="modal-content switch-admin-modal-content" style="max-width: 420px;">
        <div class="modal-header" style="border-bottom: 1px solid #e5e7eb; padding-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <svg style="width: 24px; height: 24px; color: #1e40af;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </div>
            <div>
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111827;">Switch Admin Account</h2>
              <p style="margin: 4px 0 0 0; font-size: 0.875rem; color: #6b7280;">Change to a different admin account</p>
            </div>
          </div>
          <span class="close" id="close-switch-admin-modal" style="font-size: 24px; color: #9ca3af; cursor: pointer; transition: color 0.2s;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 24px;">
          <div style="text-align: center; margin-bottom: 24px;">
            <p style="margin: 0 0 8px 0; color: #374151; font-size: 1rem; line-height: 1.5;">
              Are you sure you want to switch to another admin account?
            </p>
            <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
              You'll be logged out and redirected to the login page.
            </p>
          </div>
          <div class="form-actions" style="display: flex; gap: 12px; margin-top: 24px;">
            <button type="button" class="btn btn-secondary" id="cancel-switch-admin" style="flex: 1; padding: 12px 24px; font-weight: 500; border-radius: 8px; transition: all 0.2s;">Cancel</button>
            <button type="button" class="btn" id="confirm-switch-admin" style="flex: 1; padding: 12px 24px; font-weight: 500; border-radius: 8px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); transition: all 0.2s;">Switch Account</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Reservations Management -->
    <section id="reservations" class="section">
      <h1>Reservations</h1>
      <div class="cards">
        <div class="card">Total Reservations: <span id="total-reservations">0</span></div>
        <div class="card">Pending: <span id="pending-reservations">0</span></div>
        <div class="card">Confirmed: <span id="confirmed-reservations">0</span></div>
        <div class="card">Declined: <span id="declined-reservations">0</span></div>
        <div class="card">Cancelled: <span id="cancelled-reservations">0</span></div>
      </div>

      <h2>Reservation List</h2>
      <div class="reservations-table-container">
        <table class="reservations-table">
          <thead>
            <tr>
              <th>Product Image</th>
              <th>Product Details</th>
              <th>Customer Name</th>
              <th>Price</th>
              <th>Date/Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reservations-table-body">
            <!-- Reservations will be loaded here -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Sales -->
    <section id="sales" class="section">
      <h1>Sales</h1>
      <div class="sales-header section-header-with-action">
        <div class="sales-header-info">
          <h2>Recent Sales</h2>
          <div class="sales-total">Total sold: <span id="sales-total-amount">‚Ç±0.00</span></div>
        </div>
        <div class="sales-filters">
          <div class="sales-filter-group">
            <label for="sales-timeframe-filter">Timeframe:</label>
            <select id="sales-timeframe-filter">
            <option value="daily">Daily</option>
            <option value="monthly">Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
          </div>
          <div class="sales-filter-group" id="sales-month-group" style="display:none;">
            <select id="sales-month-filter">
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
          </div>
          <div class="sales-filter-group" id="sales-year-group" style="display:none;">
            <input id="sales-year-filter" type="number" placeholder="Year" />
          </div>
          <div class="sales-filter-group">
            <label for="sales-category-filter">Category:</label>
            <select id="sales-category-filter">
            <option value="">All Categories</option>
          </select>
        </div>
      </div>
      </div>
      <div class="sales-table-wrapper card-table-wrapper">
        <table class="card-table manual-sales-table">
          <thead>
            <tr>
              <th>Order</th>
              <th>Product</th>
              <th>Category</th>
              <th>Total</th>
              <th>Date / Time</th>
            </tr>
          </thead>
          <tbody id="sales-manual-sales-table-body">
            <tr>
              <td colspan="5" class="no-data">No sales recorded yet.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Manual Sales Entry -->
    <section id="sales-entry" class="section">
      <h1>Record Sales</h1>
      <div class="manual-sales-grid">
        <div class="manual-sales-card">
          <h2>Select Product</h2>
          <!-- Product gallery for selecting item -->
          <div id="sales-entry-product-grid" class="product-grid"></div>
        </div>
      </div>
    </section>

    <!-- Reason Input Modal -->
    <div id="reason-input-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h2>Enter Reason</h2>
          <span class="close" id="close-reason-modal">&times;</span>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="reason-input">Reason for stock change:</label>
            <input type="text" id="reason-input" placeholder="Enter reason (e.g., restock, update, adjustment, sale, etc.)" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
            <small class="text-muted">Enter your reason here:</small>
          </div>
          <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button type="button" class="btn btn-secondary" id="cancel-reason-btn">Cancel</button>
            <button type="button" class="btn" id="confirm-reason-btn">Confirm</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Sale Modal -->
    <div id="manual-sale-modal" class="modal" style="display: none;">
      <div class="modal-content" style="max-width: 420px;">
        <div class="modal-header">
          <h2>Record Sale</h2>
          <span class="close" id="close-manual-sale-modal">&times;</span>
        </div>
        <form id="manual-sale-form" class="modal-body">
          <input type="hidden" id="manual-sale-product-id">
          <div class="form-group">
            <label>Product</label>
            <div id="manual-sale-product-label" class="text-muted"></div>
          </div>
          <div class="form-group">
            <label for="manual-sale-quantity">Quantity</label>
            <input type="number" id="manual-sale-quantity" min="1" value="1" required>
            <small id="manual-sale-stock-info" class="text-muted">Stock: ‚Äî</small>
          </div>
          <div class="form-group">
            <label for="manual-sale-price">Unit Price (‚Ç±)</label>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <button type="button" id="use-retail-price-btn" class="btn btn-small" style="flex: 1;">Retail Price</button>
              <button type="button" id="use-wholesale-price-btn" class="btn btn-small btn-secondary" style="flex: 1;">Wholesale Price</button>
            </div>
            <input type="number" id="manual-sale-price" min="0" step="0.01" required readonly style="background-color: #f3f4f6; cursor: not-allowed;">
          </div>
          <div class="form-group">
            <label>Total (‚Ç±)</label>
            <div id="manual-sale-total" style="font-weight: 600; font-size: 1.2em; color: #059669;">‚Ç±0.00</div>
          </div>
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
          <div class="form-group">
            <label for="manual-sale-amount-paid">Amount Paid (‚Ç±)</label>
            <input type="number" id="manual-sale-amount-paid" min="0" step="0.01" placeholder="0.00" required>
            <small class="text-muted">Enter the amount the customer paid</small>
          </div>
          <div class="form-group">
            <label>Change (‚Ç±)</label>
            <div id="manual-sale-change" style="font-weight: 600; font-size: 1.1em; padding: 8px; background: #f3f4f6; border-radius: 4px; min-height: 20px;">
              ‚Ç±0.00
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn">Confirm Sale</button>
            <button type="button" class="btn btn-secondary" id="cancel-manual-sale">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Product History -->
    <section id="product-history" class="section">
      <h1>Product History</h1>
      
      <div class="product-history-header section-header-with-action">
        <div class="product-history-filter">
          <label for="history-category-filter">Filter by Category:</label>
          <select id="history-category-filter">
            <option value="">All Categories</option>
          </select>
        </div>
      </div>
      
      <div class="product-history-table-wrapper card-table-wrapper">
        <table id="product-history-table" class="card-table">
          <thead>
            <tr>
              <th>Date/Time</th>
              <th>Product</th>
              <th>Category</th>
              <th>Reason</th>
              <th class="text-center">Quantity Change</th>
              <th>Reference</th>
              <th>User</th>
            </tr>
          </thead>
          <tbody id="product-history-table-body">
            <tr>
              <td colspan="7" class="no-data">Loading history...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Customers -->
    <section id="customers" class="section">
      <h1>Customers</h1>
      
      <!-- Customer Overview Stats -->
      <div class="cards">
        <div class="card">Total Customers: <span>350</span></div>
        <div class="card">Average Order Value: <span>‚Ç±85</span></div>
        <div class="card">Satisfaction Rate: <span>90%</span></div>
        <div class="card">New Customers: <span>25</span></div>
      </div>

      <!-- Customer Table -->
      <div class="customer-table-section">
        <div class="section-header">
          <h2>Customer Orders & Reservations</h2>
          <div class="table-actions">
            <input type="text" id="customer-table-search" placeholder="Search customers..." class="search-input">
            <button id="export-customers-btn" class="btn btn-secondary">Export</button>
            <button id="print-customers-btn" class="btn btn-secondary">Print</button>
          </div>
        </div>
        
        <div class="customer-table-container">
          <table id="customers-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Order/Reservation ID</th>
                <th>Status</th>
                <th>Date</th>
                <th>Amount Paid</th>
                <th>Products</th>
              </tr>
            </thead>
            <tbody id="customers-table-tbody">
              <!-- Customer data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>


    <!-- Account Management -->
    <section id="account-management" class="section">
      <h1>Account Management</h1>

      <h2>Account Actions</h2>
      <div class="account-actions">
        <button id="signup-new-btn" class="btn">Sign Up New Admin/Staff</button>
      </div>

      <h2>Admin Account Management</h2>
      <div id="admin-management" class="admin-only">
        <div class="admin-table-wrapper">
          <table id="admin-users-table-main">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Status</th>
              <th>Last Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="admin-users-table">
            <tr>
                <td colspan="5" class="no-data">Loading accounts‚Ä¶</td>
            </tr>
          </tbody>
        </table>
        </div>
      </div>

      <h2>Roles & Permissions</h2>
      <div id="roles-permissions" class="admin-only">
        <div class="cards">
        </div>

        <div class="roles-table-wrapper">
          <table id="roles-matrix-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Can View Inventory</th>
              <th>Can Edit Inventory</th>
              <th>Manage Alerts</th>
              <th>Can View Sales</th>
              <th>Can View Customers</th>
              <th>Can Manage Accounts</th>
            </tr>
          </thead>
          <tbody id="roles-matrix-body">
            <tr>
                <td colspan="8" class="no-data">Loading role matrix‚Ä¶</td>
            </tr>
          </tbody>
        </table>
        </div>

        <h3>Recent Activity</h3>
        <div class="activity-log">
          <div class="activity-item">
            <span class="activity-time">2 hours ago</span>
            <span class="activity-user">Admin 2</span>
            <span class="activity-action">Updated product quantity for Widget A</span>
          </div>
          <div class="activity-item">
            <span class="activity-time">4 hours ago</span>
            <span class="activity-user">Staff 1</span>
            <span class="activity-action">Modified retail price for Product B</span>
          </div>
          <div class="activity-item">
            <span class="activity-time">1 day ago</span>
            <span class="activity-user">Admin 1</span>
            <span class="activity-action">Added new product to inventory</span>
          </div>
        </div>
      </div>

      <!-- New Account Signup Modal -->
      <div id="signup-form-modal" class="modal" style="display: none;">
        <div class="modal-content signup-modal-content">
          <div class="modal-header">
            <h2>Create New Admin/Staff Account</h2>
            <span class="close" id="close-signup-modal">&times;</span>
          </div>
          <form id="new-account-form" class="modal-body">
          <div class="form-group">
            <label for="new-username">Username:</label>
            <input type="text" id="new-username" required>
          </div>
          <div class="form-group">
            <label for="new-email">Email:</label>
            <input type="email" id="new-email" required>
          </div>
          <div class="form-group">
            <label for="new-role">Role:</label>
            <select id="new-role" required>
              <option value="admin">Admin</option>
              <option value="manager">Manager</option>
              <option value="regularUser">Regular User</option>
            </select>
          </div>
          <div class="form-group">
            <label for="new-password">Password:</label>
              <div class="password-input-wrapper">
            <input type="password" id="new-password" required>
                <button type="button" class="password-toggle" id="toggle-new-password" aria-label="Toggle password visibility">
                  <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg class="eye-icon eye-icon-hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
              <small class="text-muted">Password must be at least 6 characters long</small>
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm Password:</label>
              <div class="password-input-wrapper">
            <input type="password" id="confirm-password" required>
                <button type="button" class="password-toggle" id="toggle-confirm-password" aria-label="Toggle password visibility">
                  <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  <svg class="eye-icon eye-icon-hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                  </svg>
                </button>
              </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn">Create Account</button>
            <button type="button" id="cancel-signup" class="btn btn-secondary">Cancel</button>
          </div>
        </form>
        </div>
      </div>
    </section>

    <section id="admin-profile" class="section">
      <h1>Admin Profile</h1>
      <div class="profile-grid">
        <div class="profile-card">
          <h2>Account Overview</h2>
          <div style="text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
            <div style="position: relative; display: inline-block;">
              <img id="profile-picture-display" src="https://via.placeholder.com/120?text=No+Photo" alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
              <div style="position: absolute; bottom: 0; right: 0; width: 36px; height: 36px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); cursor: pointer;" id="profile-picture-edit-icon" title="Click to change photo">
                <span style="color: white; font-size: 18px;">üì∑</span>
              </div>
            </div>
            <h3 id="profile-display-name" style="margin: 16px 0 4px 0; font-size: 1.25rem; font-weight: 600; color: #111827;">‚Äî</h3>
            <p id="profile-display-role" style="margin: 0; color: #6b7280; font-size: 0.875rem;">‚Äî</p>
          </div>
          <ul class="profile-details">
            <li><span>Full Name</span><strong id="profile-summary-name">‚Äî</strong></li>
            <li><span>Email</span><strong id="profile-summary-email">‚Äî</strong></li>
            <li><span>Role</span><strong id="profile-summary-role">‚Äî</strong></li>
            <li><span>Phone</span><strong id="profile-summary-phone">‚Äî</strong></li>
            <li><span>Last Login</span><strong id="profile-summary-last-login">‚Äî</strong></li>
          </ul>
        </div>
        <div class="profile-card">
          <h2>Edit Profile</h2>
          <form id="admin-profile-form">
            <div class="form-group" style="text-align: center; margin-bottom: 24px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px dashed #d1d5db;">
              <label for="profile-picture" style="display: block; margin-bottom: 12px; font-weight: 500; color: #374151;">Profile Picture</label>
              <input type="file" id="profile-picture" accept="image/*" style="display: none;">
              <div id="profile-picture-preview" style="margin-bottom: 12px;">
                <img id="profile-picture-preview-img" src="" alt="Preview" style="max-width: 150px; max-height: 150px; border-radius: 50%; object-fit: cover; border: 3px solid #e5e7eb; display: none;">
              </div>
              <button type="button" class="btn btn-secondary" id="profile-picture-upload-btn" style="margin-top: 8px; padding: 8px 16px; font-size: 0.875rem;">Choose Photo</button>
              <p style="margin: 8px 0 0 0; font-size: 0.75rem; color: #6b7280;">JPG, PNG or GIF. Max size 2MB</p>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label for="profile-name">Full Name</label>
                <input type="text" id="profile-name" required>
              </div>
              <div class="form-group">
                <label for="profile-email">Email</label>
                <input type="email" id="profile-email" disabled style="background-color: #f3f4f6; cursor: not-allowed;">
              </div>
              <div class="form-group">
                <label for="profile-phone">Phone</label>
                  <input type="tel" id="profile-phone" placeholder="+82 10-1234-5678">
              </div>
            </div>
            <div class="form-group">
              <label for="profile-new-password">New Password <span style="color: #6b7280; font-weight: normal;">(optional)</span></label>
              <input type="password" id="profile-new-password" placeholder="Enter new password">
            </div>
            <div class="form-group">
              <label for="profile-confirm-password">Confirm New Password <span style="color: #6b7280; font-weight: normal;">(optional)</span></label>
              <input type="password" id="profile-confirm-password" placeholder="Confirm new password">
            </div>
            <div class="form-actions">
              <button type="submit" class="btn">Save Changes</button>
              <button type="reset" class="btn btn-secondary" id="profile-reset-btn">Reset</button>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>
  
  <script src="config.js"></script>
  <script src="auth.js"></script>
  <script src="inventory-utils.js"></script>
  <script src="admin.js"></script>
  <script src="account-management.js"></script>
  <script>
    // Admin Dashboard JavaScript
    (function(){
      var auth = window.KSurplusAuth;
      var inventoryUtils = window.InventoryUtils;
      var adminSession = (window.AdminShell && window.AdminShell.getSession && window.AdminShell.getSession()) || null;
      if (!adminSession && auth) {
        try {
          adminSession = auth.requireAdmin(['superAdmin','admin','manager','regularUser']);
        } catch(e) {
          window.location.replace('login.html');
          return;
        }
      }
      if (!adminSession || !adminSession.user) {
        window.location.replace('login.html');
        return;
      }
      var currentUser = adminSession.user;
      var permissions = adminSession.permissions || {};
      var canEditInventory = !!(permissions.inventory && permissions.inventory.edit);
      var canEditProfile = !!(permissions.profile && permissions.profile.edit);
      var roleMap = auth && auth.ROLE_DEFINITIONS ? auth.ROLE_DEFINITIONS : {};

      // Update header info based on signed-in user role/name
      (function updateHeaderUserInfo() {
        if (!currentUser) return;
        var logoEl = document.querySelector('.logo');
        var roleEl = document.getElementById('current-user-role');
        var nameEl = document.getElementById('current-user-name');
        var roleLabel = roleMap[currentUser.role] ? roleMap[currentUser.role].label : (currentUser.role || 'Admin');

        if (logoEl) {
          // Show Super Admin Panel only for superAdmin accounts; otherwise Admin Panel
          logoEl.textContent = currentUser.role === 'superAdmin' ? 'Super Admin Panel' : 'Admin Panel';
        }
        if (roleEl) roleEl.textContent = roleLabel;
        if (nameEl) nameEl.textContent = currentUser.name || 'Admin';
      })();

      // Initialize products array - will be loaded from localStorage
      var products = [];
      var originalProductStock = {}; // Track original stock values
      var pendingStockChanges = {};
      var hasUnsavedInventoryChanges = false;
      // Use config.js for API URL, fallback to localhost for development
      var API_BASE_URL = (window.APP_CONFIG && window.APP_CONFIG.baseUrl) 
        ? window.APP_CONFIG.baseUrl.replace(/\/+$/, '')
        : (window.APP_API_BASE_URL || 'http://localhost:3000').replace(/\/+$/, '');
      var DEFAULT_PRODUCT_IMAGE = 'https://via.placeholder.com/70?text=No+Image';

      // Mobile Menu Toggle
      (function() {
        var mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        var sidebar = document.getElementById('sidebar');
        var sidebarOverlay = document.createElement('div');
        sidebarOverlay.className = 'sidebar-overlay';
        document.body.appendChild(sidebarOverlay);

        function toggleSidebar() {
          if (sidebar) {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
            if (mobileMenuToggle) {
              mobileMenuToggle.classList.toggle('active');
            }
          }
        }

        function closeSidebar() {
          if (sidebar) {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
            if (mobileMenuToggle) {
              mobileMenuToggle.classList.remove('active');
            }
          }
        }

        if (mobileMenuToggle) {
          mobileMenuToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleSidebar();
          });
        }

        sidebarOverlay.addEventListener('click', closeSidebar);

        // Close sidebar when clicking on a nav link (mobile)
        if (sidebar) {
          var navLinks = sidebar.querySelectorAll('nav a');
          navLinks.forEach(function(link) {
            link.addEventListener('click', function() {
              if (window.innerWidth <= 768) {
                closeSidebar();
              }
            });
          });
        }

        // Close sidebar on window resize if it becomes desktop size
        window.addEventListener('resize', function() {
          if (window.innerWidth > 768) {
            closeSidebar();
          }
        });
      })();

      function resolveProductImage(rawImageValue) {
        if (rawImageValue === null || rawImageValue === undefined) {
          return DEFAULT_PRODUCT_IMAGE;
        }
        var value = String(rawImageValue).trim();
        if (!value || value === 'null' || value === 'undefined') {
          return DEFAULT_PRODUCT_IMAGE;
        }
        if (/^(data:|blob:|https?:\/\/)/i.test(value)) {
          return value;
        }
        var normalizedBase = API_BASE_URL;
        var normalizedPath = value.replace(/^\/+/, '');
        return normalizedBase + '/' + normalizedPath;
      }
      
      function getProductById(productId) {
        // Handle different ID formats: numeric, string, or 'p' prefixed
        var idStr = String(productId);
        var numericId = idStr.startsWith('p') ? idStr.substring(1) : idStr;
        var prefixedId = 'p' + numericId;
        
        return products.find(function(product) {
          var productIdStr = String(product.id);
          // Match exact ID, numeric ID, or 'p' prefixed ID
          return productIdStr === idStr || 
                 productIdStr === numericId || 
                 productIdStr === prefixedId ||
                 productIdStr === 'p' + idStr ||
                 (productIdStr.startsWith('p') && productIdStr.substring(1) === numericId);
        }) || null;
      }

      function getDisplayStock(product) {
        if (!product) return 0;
        return Object.prototype.hasOwnProperty.call(pendingStockChanges, product.id)
          ? pendingStockChanges[product.id]
          : product.stock;
      }

      function getDisplayStockById(productId) {
        if (Object.prototype.hasOwnProperty.call(pendingStockChanges, productId)) {
          return pendingStockChanges[productId];
        }
        var product = getProductById(productId);
        return product ? product.stock : 0;
      }

      function updateUnsavedState() {
        hasUnsavedInventoryChanges = Object.keys(pendingStockChanges).length > 0;
        var banner = document.getElementById('inventory-unsaved-banner');
        if (banner) {
          banner.hidden = !hasUnsavedInventoryChanges;
        }
      }

      function syncRowDirtyState(productId) {
        var row = document.querySelector('tr[data-product-id="' + productId + '"]');
        var hasPending = Object.prototype.hasOwnProperty.call(pendingStockChanges, productId);
        if (row) {
          row.classList.toggle('dirty', hasPending);
        }
        var saveBtn = document.querySelector('[data-save-product="' + productId + '"]');
        if (saveBtn) {
          saveBtn.classList.toggle('dirty', hasPending);
          saveBtn.disabled = !hasPending;
        }
      }

      function setPendingStockValue(productId, newStock) {
        var product = getProductById(productId);
        if (!product) return;
        var baseStock = product.stock;
        if (newStock === baseStock) {
          delete pendingStockChanges[productId];
        } else {
          pendingStockChanges[productId] = newStock;
        }
        syncRowDirtyState(productId);
        updateUnsavedState();
      }

      function getProductsSnapshot() {
        return products.map(function(product) {
          return Object.assign({}, product, {
            stock: getDisplayStock(product)
          });
        });
      }

      // Load products from localStorage on page load (fallback)
      var savedProducts = localStorage.getItem('products');
      if (savedProducts) {
        products = JSON.parse(savedProducts);
        products.forEach(function(product) {
          originalProductStock[product.id] = product.stock;
          product.image = resolveProductImage(product.image);
        });
        pendingStockChanges = {};
        updateUnsavedState();
        // Populate category filter from localStorage products
        populateCategoryFilter();
        renderSalesEntryGrid();
      }

      // Load reservations from database API
      var reservations = [];
      
      // Fetch reservations from server
      function loadReservationsFromServer() {
        return fetch(API_BASE_URL + '/api/reservations')
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Failed to fetch reservations');
            }
            return response.json();
          })
          .then(function(data) {
            reservations = Array.isArray(data) ? data : [];
            renderReservations();
            return reservations;
          })
          .catch(function(error) {
            console.error('Error loading reservations:', error);
            reservations = [];
            renderReservations();
            return [];
          });
      }

      // Fetch latest products from the API so logging out/in keeps data in sync
      function loadProductsFromServer() {
        return fetch(API_BASE_URL + '/api/products')
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Failed to load products');
            }
            return response.json();
          })
          .then(function(apiProducts) {
            if (!Array.isArray(apiProducts)) {
              console.warn('Unexpected products response, falling back to localStorage');
              return;
            }

            products = apiProducts.map(function(apiProduct) {
              var localId = 'p' + apiProduct.id;
              originalProductStock[localId] = apiProduct.stock_quantity;
              var resolvedImage = resolveProductImage(apiProduct.image_url || apiProduct.image);
              
              // Handle wholesale_price - check for null, undefined, and allow 0
              var wholesalePrice = null;
              if (apiProduct.wholesale_price !== null && apiProduct.wholesale_price !== undefined && apiProduct.wholesale_price !== '') {
                wholesalePrice = parseFloat(apiProduct.wholesale_price);
                if (isNaN(wholesalePrice)) {
                  wholesalePrice = null;
                }
              }
              
              // Debug log for first product to see what we're getting
              if (apiProduct.id === apiProducts[0].id) {
                console.log('Sample product from server:', {
                  id: apiProduct.id,
                  name: apiProduct.name,
                  wholesale_price_raw: apiProduct.wholesale_price,
                  wholesale_price_parsed: wholesalePrice
                });
              }
              
              return {
                id: localId,
                name: apiProduct.name,
                brand: apiProduct.brand,
                category: apiProduct.category_name || 'Uncategorized',
                size: apiProduct.size,
                condition: apiProduct.condition_grade,
                price: parseFloat(apiProduct.retail_price),
                originalPrice: apiProduct.original_price ? parseFloat(apiProduct.original_price) : null,
                wholesalePrice: wholesalePrice,
                stock: apiProduct.stock_quantity,
                lowStockThreshold: apiProduct.low_stock_threshold || 5,
                low_stock_threshold: apiProduct.low_stock_threshold || 5,
                availability: (apiProduct.stock_quantity || 0) > 0 ? 'In Stock' : 'Out of Stock',
                image: resolvedImage
              };
            });

            // Try to cache products in localStorage, but don't break UI if quota is exceeded
            try {
              localStorage.setItem('products', JSON.stringify(products));
            } catch (storageError) {
              console.warn('‚ö†Ô∏è Unable to cache products in localStorage (quota exceeded). Continuing without cache.', storageError);
            }
            pendingStockChanges = {};
            updateUnsavedState();
            populateCategoryFilter(); // Inventory filter
            populateHistoryCategoryFilter(); // Product history filter
            populateBrandAndCategoryComboboxes(); // Update comboboxes with new data
            renderInventory();
            updateLowStockAlerts();
            renderSalesEntryGrid();
          })
          .catch(function(error) {
            console.error('Failed to load products from server. Using cached data.', error);
            renderSalesEntryGrid();
            throw error; // Re-throw so calling code knows it failed
          });
      }
      
      // Populate category filter dropdown - based on categories from created products
      function populateCategoryFilter() {
        console.log('üîç populateCategoryFilter() called');
        var categoryFilter = document.getElementById('product-category-filter');
        if (!categoryFilter) {
          console.warn('‚ö†Ô∏è Category filter element not found! Looking for: product-category-filter');
          // Try to find it with a delay
          setTimeout(function() {
            var retryFilter = document.getElementById('product-category-filter');
            if (retryFilter) {
              console.log('‚úÖ Found category filter on retry');
              populateCategoryFilter();
            } else {
              console.error('‚ùå Category filter element still not found after retry');
            }
          }, 500);
          return;
        }

        console.log('‚úÖ Category filter element found, products array length:', products.length);

        // Extract unique categories from products (from created products)
        var categories = new Set();

        // Base categories that should always appear in the filter
        [
          'Home & Furniture',
          'Kitchenware & Tableware',
          'Electronics & Appliances',
          'Fashion & Accessories (Ukay-Ukay)',
          'Miscellaneous'
        ].forEach(function(baseCategory) {
          categories.add(baseCategory);
        });

        products.forEach(function(product, index) {
          // Check multiple possible category field names
          var category = product.category || product.category_name || product.categoryName;
          console.log('Product', index, ':', {
            id: product.id,
            name: product.name,
            category: category,
            category_name: product.category_name,
            categoryName: product.categoryName,
            allKeys: Object.keys(product)
          });
          if (category && String(category).trim() && String(category).trim() !== 'Uncategorized') {
            categories.add(String(category).trim());
            console.log('‚úÖ Found category:', category);
          }
        });
        
        console.log('üìã Extracted categories:', Array.from(categories));
        
        // Save current selection
        var currentValue = categoryFilter.value;
        
        // Clear and rebuild options
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        
        // Add categories from products, sorted alphabetically
        Array.from(categories).sort().forEach(function(category) {
          var option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          categoryFilter.appendChild(option);
          console.log('‚ûï Added category option:', category);
        });
        
        // Restore selection if it still exists
        if (currentValue && Array.from(categories).includes(currentValue)) {
          categoryFilter.value = currentValue;
        }
        
        console.log('‚úÖ Category filter dropdown updated with', categories.size, 'categories from products');
        
        // If no categories found, log a warning with more details
        if (categories.size === 0) {
          console.warn('‚ö†Ô∏è No categories found in products array.');
          console.warn('‚ö†Ô∏è Sample products:', products.slice(0, 3).map(function(p) {
            return { id: p.id, name: p.name, category: p.category, category_name: p.category_name };
          }));
        }
      }
      
      // Populate brand and category comboboxes (datalists)
      function populateBrandAndCategoryComboboxes() {
        // Extract unique brands and categories from products
        var brands = new Set();
        var categories = new Set();

        // Base categories that should always be available
        [
          'Home & Furniture',
          'Kitchenware & Tableware',
          'Electronics & Appliances',
          'Fashion & Accessories (Ukay-Ukay)',
          'Miscellaneous'
        ].forEach(function(baseCategory) {
          categories.add(baseCategory);
        });
        
        products.forEach(function(product) {
          if (product.brand && product.brand.trim()) {
            brands.add(product.brand.trim());
          }
          if (product.category && product.category.trim()) {
            categories.add(product.category.trim());
          }
        });
        
        // Populate brand datalists
        var brandList = document.getElementById('brand-list');
        var editBrandList = document.getElementById('edit-brand-list');
        
        if (brandList) {
          brandList.innerHTML = '';
          Array.from(brands).sort().forEach(function(brand) {
            var option = document.createElement('option');
            option.value = brand;
            brandList.appendChild(option);
          });
        }
        
        if (editBrandList) {
          editBrandList.innerHTML = '';
          Array.from(brands).sort().forEach(function(brand) {
            var option = document.createElement('option');
            option.value = brand;
            editBrandList.appendChild(option);
          });
        }
        
        // Populate category datalists
        var categoryList = document.getElementById('category-list');
        var editCategoryList = document.getElementById('edit-category-list');
        
        if (categoryList) {
          categoryList.innerHTML = '';
          Array.from(categories).sort().forEach(function(category) {
            var option = document.createElement('option');
            option.value = category;
            categoryList.appendChild(option);
          });
        }
        
        if (editCategoryList) {
          editCategoryList.innerHTML = '';
          Array.from(categories).sort().forEach(function(category) {
            var option = document.createElement('option');
            option.value = category;
            editCategoryList.appendChild(option);
          });
        }
        
        // Also populate the category filter dropdown (select element)
        var categoryFilter = document.getElementById('product-category-filter');
        if (categoryFilter) {
          var currentValue = categoryFilter.value;
          categoryFilter.innerHTML = '<option value="">All Categories</option>';
          
          Array.from(categories).sort().forEach(function(category) {
            var option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
          });
          
          // Restore selection if it still exists
          if (currentValue && Array.from(categories).includes(currentValue)) {
            categoryFilter.value = currentValue;
          }
          
          console.log('‚úÖ Category filter dropdown populated with', categories.size, 'categories');
        } else {
          console.warn('‚ö†Ô∏è Category filter element (product-category-filter) not found');
        }
        
        console.log('Comboboxes updated:', {
          brands: Array.from(brands).length,
          categories: Array.from(categories).length
        });
      }

      function enforceSectionAccess(){
        var inventorySection = document.getElementById('inventory');
        var inventoryRestricted = document.getElementById('inventory-restricted');
        var salesSection = document.getElementById('sales');
        var salesEntrySection = document.getElementById('sales-entry');
        var customersSection = document.getElementById('customers');
        var accountSection = document.getElementById('account-management');
        var reservationsSection = document.getElementById('reservations');
        var profileNav = document.querySelector('a[href="#admin-profile"]');
        var accountNav = document.querySelector('a[href="#account-management"]');
        var salesNav = document.querySelector('a[href="#sales"]');
        var salesEntryNav = document.querySelector('a[href="#sales-entry"]');
        var customersNav = document.querySelector('a[href="#customers"]');
        var addProductBtn = document.getElementById('add-product-btn');

        var canViewInventory = !(permissions.inventory && permissions.inventory.view === false);
        canEditInventory = !!(permissions.inventory && permissions.inventory.edit);
        var canViewSales = !!(permissions.sales && permissions.sales.view);
        var canViewCustomers = !!(permissions.customers && permissions.customers.view);
        var canManageAccounts = !!(permissions.accounts && permissions.accounts.manage);

        if (inventorySection && inventoryRestricted) {
          inventoryRestricted.hidden = canViewInventory;
          inventorySection.querySelectorAll('.inventory-actions, .cards, table, #low-stock-section, #low-stock-alert-banner').forEach(function(el){
            el.style.display = canViewInventory ? '' : 'none';
          });
        }

        if (salesSection) {
          salesSection.style.display = canViewSales ? '' : 'none';
          if (salesNav) salesNav.parentElement.style.display = canViewSales ? '' : 'none';
        }
        if (salesEntrySection) {
          salesEntrySection.style.display = canViewSales ? '' : 'none';
          if (salesEntryNav) salesEntryNav.parentElement.style.display = canViewSales ? '' : 'none';
        }

        if (customersSection) {
          customersSection.style.display = canViewCustomers ? '' : 'none';
          if (customersNav) customersNav.parentElement.style.display = 'none'; // Always hide customers tab
        }

        if (accountSection) {
          accountSection.style.display = canManageAccounts ? '' : 'none';
          if (accountNav) accountNav.parentElement.style.display = canManageAccounts ? '' : 'none';
        }

        canEditProfile = !!(permissions.profile && permissions.profile.edit);
        var profileSection = document.getElementById('admin-profile');
        if (profileSection) {
          profileSection.style.display = canEditProfile ? '' : 'none';
        }
        if (profileNav) {
          profileNav.parentElement.style.display = permissions.profile && permissions.profile.edit ? '' : 'none';
        }

        document.body.dataset.canEditInventory = canEditInventory ? 'true' : 'false';
        // Allow add product button to work - permissions check happens on form submission
        // Don't disable the button, just check permissions when submitting
        if (addProductBtn) {
          // Only disable if explicitly denied, not if permission is undefined
          var isExplicitlyDenied = permissions.inventory && permissions.inventory.edit === false;
          addProductBtn.disabled = isExplicitlyDenied;
          addProductBtn.classList.toggle('disabled', isExplicitlyDenied);
        }
      }

      enforceSectionAccess();
      loadProductsFromServer().then(function() {
        // Ensure category filters are populated after products load
        setTimeout(function() {
          populateCategoryFilter(); // Inventory filter
          populateHistoryCategoryFilter(); // Product history filter
        }, 100);
      }).catch(function(error) {
        console.error('Error loading products:', error);
        // Still try to populate from localStorage if available
        setTimeout(function() {
          populateCategoryFilter(); // Inventory filter
          populateHistoryCategoryFilter(); // Product history filter
        }, 100);
      });
      
      // Also ensure category filters are populated after a short delay (in case products load from localStorage first)
      setTimeout(function() {
        console.log('Delayed category filter population, products count:', products.length);
        populateCategoryFilter(); // Inventory filter
        populateHistoryCategoryFilter(); // Product history filter
      }, 1000);

      function applyInventoryEditState(){
        var qtyInputs = document.querySelectorAll('#inventory .qty-input');
        qtyInputs.forEach(function(input){
          input.readOnly = !canEditInventory;
        });
        var stepButtons = document.querySelectorAll('#inventory .stepper-btn');
        stepButtons.forEach(function(btn){
          btn.disabled = !canEditInventory;
          btn.classList.toggle('disabled', !canEditInventory);
        });
        var actionButtons = document.querySelectorAll('#low-stock-section .btn');
        actionButtons.forEach(function(btn){
          btn.disabled = !canEditInventory;
          btn.classList.toggle('disabled', !canEditInventory);
        });
      }

      // Low Stock Threshold (configurable)
      const LOW_STOCK_THRESHOLD = (inventoryUtils && inventoryUtils.getThreshold()) || 5;

      // Check for low stock items - uses each product's individual low_stock_threshold
      function getLowStockItems() {
        var snapshot = getProductsSnapshot();
        return snapshot.filter(function(product) {
          // Use product's individual low_stock_threshold, or default to 5 if not set
          var threshold = product.low_stock_threshold || product.lowStockThreshold || 5;
          return product.stock > 0 && product.stock <= threshold;
        });
      }

      // Check if low stock section was dismissed
      function isLowStockSectionDismissed() {
        return localStorage.getItem('lowStockSectionDismissed') === 'true';
      }
      
      // Dismiss low stock section permanently
      function dismissLowStockSection() {
        localStorage.setItem('lowStockSectionDismissed', 'true');
        var lowStockSection = document.getElementById('low-stock-section');
        if (lowStockSection) {
          lowStockSection.style.display = 'none';
        }
      }
      
      // Update low stock alerts
      function updateLowStockAlerts() {
        var lowStockItems = getLowStockItems();
        var lowStockCount = lowStockItems.length;
        
        // Update sidebar badge
        var sidebarBadge = document.getElementById('sidebar-low-stock-badge');
        if (sidebarBadge) {
          if (lowStockCount > 0) {
            sidebarBadge.textContent = lowStockCount;
            sidebarBadge.style.display = 'inline-block';
          } else {
            sidebarBadge.style.display = 'none';
          }
        }
        
        // Update alert banner
        var alertBanner = document.getElementById('low-stock-alert-banner');
        var lowStockCountSpan = document.getElementById('low-stock-count');
        if (alertBanner && lowStockCountSpan) {
          if (lowStockCount > 0) {
            lowStockCountSpan.textContent = lowStockCount;
            alertBanner.style.display = 'block';
          } else {
            alertBanner.style.display = 'none';
          }
        }
        
        // Update low stock items count in cards
        var lowStockItemsCount = document.getElementById('low-stock-items-count');
        if (lowStockItemsCount) {
          lowStockItemsCount.textContent = lowStockCount;
          var isClear = lowStockCount === 0;
          lowStockItemsCount.classList.toggle('low-stock-clear', isClear);
          lowStockItemsCount.classList.toggle('low-stock-alert', !isClear);
        }
        
        // Render low stock items section
        renderLowStockItems(lowStockItems);
        
        // Show low stock section if there are items and not dismissed
        var lowStockSection = document.getElementById('low-stock-section');
        if (lowStockSection) {
          var shouldShow = lowStockCount > 0 && !isLowStockSectionDismissed();
          lowStockSection.style.display = shouldShow ? 'block' : 'none';
        }
        
        // Update notification badge
        updateNotificationBadge();

        if (inventoryUtils && inventoryUtils.evaluateAlerts) {
          var snapshotForAlerts = getProductsSnapshot();
          inventoryUtils.evaluateAlerts(snapshotForAlerts, function(alerts){
            alerts.forEach(function(alert){
              var type = alert.severity === 'critical' ? 'warning' : 'info';
              showLowStockNotification(alert.name + ' is running low (' + alert.stock + ' left).', type);
            });
          });
        }
      }

      // Render low stock items
      function renderLowStockItems(lowStockItems) {
        var grid = document.getElementById('low-stock-items-grid');
        if (!grid) return;
        
        if (lowStockItems.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No low stock items. All products are well-stocked!</p>';
          return;
        }
        
        grid.innerHTML = '';
        lowStockItems.forEach(function(product) {
          var itemCard = document.createElement('div');
          itemCard.className = 'low-stock-item-card';
          var productImage = resolveProductImage(product.image);
          // Use product's individual low_stock_threshold, or default to 5 if not set
          var productThreshold = product.low_stock_threshold || product.lowStockThreshold || 5;
          var stockMeta = inventoryUtils ? inventoryUtils.getStockMeta(product.stock, productThreshold) : {
            percentage: Math.max(5, Math.min(100, (product.stock / productThreshold) * 100)),
            severity: product.stock <= Math.max(1, Math.floor(productThreshold / 2)) ? 'critical' : 'warning'
          };
          var restockDisabled = canEditInventory ? '' : 'disabled';
          
          itemCard.innerHTML = `
            <div class="low-stock-item-image">
              <img src="${productImage}" alt="${product.name}" onerror="this.onerror=null;this.src='${DEFAULT_PRODUCT_IMAGE}';">
            </div>
            <div class="low-stock-item-details">
              <h3>${product.name}</h3>
              <p class="low-stock-item-info">${product.brand} ‚Ä¢ ${product.category}</p>
              <div class="low-stock-progress">
                <div class="low-stock-progress-bar">
                  <div class="low-stock-progress-fill ${stockMeta.severity}" style="width: ${stockMeta.percentage}%"></div>
                </div>
                <span class="low-stock-quantity">${product.stock} / ${productThreshold} remaining</span>
              </div>
              <div class="low-stock-actions">
                <button class="btn btn-small" ${restockDisabled} onclick="updateQuantity('${product.id}', 10)">Restock +10</button>
                <button class="btn btn-small btn-secondary" ${restockDisabled} onclick="updateQuantity('${product.id}', 20)">Restock +20</button>
              </div>
            </div>
          `;
          grid.appendChild(itemCard);
        });
      }

      function triggerQuantityStep(button){
        if (!button || button.disabled) return;
        var productId = button.getAttribute('data-product-id');
        var step = parseInt(button.getAttribute('data-step'), 10);
        if (!productId || Number.isNaN(step)) return;
        updateQuantity(productId, step);
      }

      function bindQuantitySteppers(){
        var tableBody = document.getElementById('inventory-table-body');
        if (!tableBody) return;

        tableBody.addEventListener('pointerdown', function(event){
          var button = event.target.closest('.stepper-btn');
          if (!button || button.disabled) return;
          if (event.pointerType === 'touch' || event.pointerType === 'pen') {
            event.preventDefault();
            button.dataset.skipClick = 'true';
            triggerQuantityStep(button);
          }
        }, { passive: false });

        tableBody.addEventListener('click', function(event){
          var button = event.target.closest('.stepper-btn');
          if (!button || button.disabled) return;
          if (button.dataset.skipClick === 'true') {
            delete button.dataset.skipClick;
            return;
          }
          event.preventDefault();
          triggerQuantityStep(button);
        });

        tableBody.addEventListener('keydown', function(event){
          if (!event.target.classList.contains('stepper-btn')) return;
          if (event.key !== 'Enter' && event.key !== ' ') return;
          event.preventDefault();
          triggerQuantityStep(event.target);
        });

        tableBody.addEventListener('input', function(event){
          var input = event.target.closest('.qty-input');
          if (!input || input.readOnly) return;
          handleManualQuantityInput(input);
        });

        tableBody.addEventListener('change', function(event){
          var input = event.target.closest('.qty-input');
          if (!input || input.readOnly) return;
          handleManualQuantityInput(input);
        });
      }

      function handleManualQuantityInput(inputElement) {
        if (!canEditInventory || !inputElement) return;
        var productId = inputElement.getAttribute('data-product-id');
        if (!productId) return;
        var rawValue = parseInt(inputElement.value, 10);
        var sanitizedValue = Number.isNaN(rawValue) ? 0 : Math.max(0, rawValue);
        inputElement.value = sanitizedValue;
        setPendingStockValue(productId, sanitizedValue);
        updateInventoryStats();
        updateLowStockAlerts();
      }

      // Filter products based on search and category
      var filteredProducts = [];
      var currentSearchTerm = '';
      var currentCategoryFilter = '';
      
      function getFilteredProducts() {
        var searchTerm = (currentSearchTerm || '').toLowerCase().trim();
        var categoryFilter = currentCategoryFilter || '';
        
        return products.filter(function(product) {
          var matchesSearch = !searchTerm || 
            product.name.toLowerCase().includes(searchTerm) ||
            (product.brand && product.brand.toLowerCase().includes(searchTerm));
          
          var matchesCategory = !categoryFilter || product.category === categoryFilter;
          
          return matchesSearch && matchesCategory;
        });
      }
      
      // Render inventory table (optimized with document fragments)
      function renderInventory(){
        var tbody = document.getElementById('inventory-table-body');
        if (!tbody) return;

        filteredProducts = getFilteredProducts();
        
        if (filteredProducts.length === 0){
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280;">No products found</td></tr>';
          updateInventoryStats();
          updateLowStockAlerts();
          return;
        }

        // Use document fragment for batch DOM insertion (performance optimization)
        var fragment = document.createDocumentFragment();
        var rows = [];
        
        filteredProducts.forEach(function(product){
          // Track original stock if not already tracked
          if (!originalProductStock.hasOwnProperty(product.id)) {
            originalProductStock[product.id] = product.stock;
          }
          
          var row = document.createElement('tr');
          row.className = 'inventory-row';
          row.dataset.productId = product.id;
          var currentStock = getDisplayStock(product);
          var productImage = resolveProductImage(product.image);
          // Use product's individual low_stock_threshold, or default to 5 if not set
          var productThreshold = product.low_stock_threshold || product.lowStockThreshold || 5;
          var stockMeta = inventoryUtils ? inventoryUtils.getStockMeta(currentStock, productThreshold) : {
            label: currentStock > productThreshold * 2 ? 'In Stock' : currentStock > 0 ? 'Low Stock' : 'Out of Stock',
            className: currentStock > productThreshold * 2 ? 'ok' : currentStock > 0 ? 'warning' : 'danger',
            status: currentStock > 0 ? (currentStock <= productThreshold ? 'low' : 'high') : 'out'
          };
          // Use actual wholesale_price from database, or calculate 70% as fallback
          var wholesalePrice = (product.wholesalePrice !== null && product.wholesalePrice !== undefined) 
            ? product.wholesalePrice 
            : (Math.round(product.price * 0.7 * 100) / 100); // Fallback to 70% if not set
          var lowStockIndicator = (stockMeta.status === 'low' || stockMeta.status === 'out') ? '<span class="low-stock-indicator" title="Low Stock Alert">‚ö†Ô∏è</span>' : '';
          var stepperDisabled = canEditInventory ? '' : 'disabled';
          var readOnlyAttr = canEditInventory ? '' : 'readonly';
          var hasPendingChange = Object.prototype.hasOwnProperty.call(pendingStockChanges, product.id);
          var saveBtnDirtyClass = hasPendingChange ? ' dirty' : '';
          var saveBtnDisabledAttr = hasPendingChange ? '' : 'disabled';
          
          row.innerHTML = `
            <td style="width: 100px; padding: 12px; vertical-align: middle; text-align: center;">
              <img src="${productImage}" alt="${product.name}" style="width: 70px; height: 70px; object-fit: cover; border-radius: 6px;" onerror="this.onerror=null;this.src='${DEFAULT_PRODUCT_IMAGE}';">
            </td>
            <td style="width: 200px; min-width: 200px; max-width: 200px; padding: 12px; vertical-align: middle; text-align: center; word-wrap: break-word;">
              <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; gap: 8px; text-align: center; min-height: 24px;">
                <span style="text-align: center;">${product.name}</span> ${lowStockIndicator}
              </div>
              <div style="font-size: 0.85rem; color: #6b7280; text-align: center; min-height: 18px;">${product.brand} - ${product.category}</div>
            </td>
            <td style="width: 150px; padding: 12px; vertical-align: middle; text-align: center;">
              <div class="stepper" style="display: flex; align-items: center; justify-content: center; gap: 4px;">
                <button type="button" class="stepper-btn" data-step="-1" data-product-id="${product.id}" ${stepperDisabled} aria-label="Decrease ${product.name} quantity">-</button>
                <input class="qty-input" type="number" value="${currentStock}" min="0" id="qty-${product.id}" data-product-id="${product.id}" ${readOnlyAttr} style="width: 60px; text-align: center;">
                <button type="button" class="stepper-btn" data-step="1" data-product-id="${product.id}" ${stepperDisabled} aria-label="Increase ${product.name} quantity">+</button>
              </div>
            </td>
            <td style="width: 120px; padding: 12px; vertical-align: middle; text-align: center;"><span class="badge ${stockMeta.className}" data-stock-status>${stockMeta.label}</span></td>
            <td style="width: 120px; padding: 12px; vertical-align: middle; text-align: center; font-weight: 600; color: #dc2626;">‚Ç±${product.price}</td>
            <td style="width: 120px; padding: 12px; vertical-align: middle; text-align: center; font-weight: 600; color: #059669;">${wholesalePrice !== null && wholesalePrice !== undefined ? '‚Ç±' + parseFloat(wholesalePrice).toFixed(2) : '‚Äî'}</td>
            <td style="width: 180px; padding: 12px; vertical-align: middle; text-align: center;">
              <button class="btn-small btn-success${saveBtnDirtyClass}" data-save-product="${product.id}" onclick="saveProductChanges('${product.id}')" ${stepperDisabled} ${saveBtnDisabledAttr} style="margin-top: 4px; margin-right: 4px;">üíæ Save</button>
              <button class="btn-small btn-secondary" onclick="openEditProductModal('${product.id}')" style="margin-top: 4px; margin-right: 4px;">‚úèÔ∏è Edit</button>
              <button class="btn-small btn-danger" onclick="deleteProduct('${product.id}')" style="margin-top: 4px;">üóëÔ∏è Delete</button>
            </td>
          `;
          fragment.appendChild(row);
          rows.push({row: row, productId: product.id});
        });
        
        // Batch DOM update - clear and append fragment in one operation
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
        
        // Add data-label attributes for mobile responsive view
        var headerCells = document.querySelectorAll('#inventory-table thead th');
        var headerLabels = Array.from(headerCells).map(function(th) {
          return th.textContent.trim();
        });
        
        rows.forEach(function(item) {
          var cells = item.row.querySelectorAll('td');
          cells.forEach(function(cell, index) {
            if (index < headerLabels.length && index > 0) { // Skip first cell (image)
              cell.setAttribute('data-label', headerLabels[index]);
            }
          });
        });
        
        // Sync row states after DOM update
        rows.forEach(function(item) {
          syncRowDirtyState(item.productId);
        });
        
        // Update stats, alerts, and permissions
        updateInventoryStats();
        updateLowStockAlerts();
        applyInventoryEditState();
      }

      // Delete product from inventory and database
      window.deleteProduct = function(productId) {
        if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
          return;
        }

        // Extract numeric ID if it has the "p" prefix (e.g. "p12")
        var numericId = productId.toString().startsWith('p')
          ? productId.toString().substring(1)
          : productId;

        fetch(API_BASE_URL + '/api/products/' + numericId, {
          method: 'DELETE'
        })
          .then(function(response) {
            if (!response.ok) {
              return response.json().then(function(data) {
                throw new Error(data.error || 'Failed to delete product');
              }).catch(function() {
                throw new Error('Failed to delete product');
              });
            }

            // 1) Immediately remove from local products so the row disappears right away
            var targetIdStr = String(productId);
            products = products.filter(function(p) {
              return String(p.id) !== targetIdStr;
            });
            try {
              localStorage.setItem('products', JSON.stringify(products));
            } catch (e) {
              console.warn('‚ö†Ô∏è Unable to update products cache after delete.', e);
            }
            renderInventory(); // instant visual feedback

            // 2) Reload products from server so UI stays in sync with database
            return loadProductsFromServer().catch(function(err) {
              console.warn('‚ö†Ô∏è Failed to refresh products from server after delete.', err);
            });
          })
          .then(function() {
            renderInventory();
            updateLowStockAlerts();
            populateCategoryFilter();
            populateHistoryCategoryFilter();
            alert('Product deleted successfully.');
          })
          .catch(function(error) {
            console.error('Error deleting product:', error);
            alert('Error deleting product: ' + error.message);
          });
      }

      // Update inventory statistics
      function updateInventoryStats() {
        var totalProducts = filteredProducts.length > 0 ? filteredProducts.length : products.length;
        var inventoryValue = products.reduce(function(sum, product) {
          return sum + (product.price * getDisplayStock(product));
        }, 0);
        
        var totalProductsCount = document.getElementById('total-products-count');
        var inventoryValueSpan = document.getElementById('inventory-value');
        
        if (totalProductsCount) {
          totalProductsCount.textContent = totalProducts;
        }
        if (inventoryValueSpan) {
          inventoryValueSpan.textContent = '‚Ç±' + inventoryValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
      }

      // Update sales today total income
      function updateSalesTodayCount() {
        var salesTodayCountEl = document.getElementById('sales-today-count');
        if (!salesTodayCountEl) return;

        if (!manualSales || !Array.isArray(manualSales) || manualSales.length === 0) {
          salesTodayCountEl.textContent = '‚Ç±0.00';
          return;
        }

        // Get today's date (start of day)
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var todayEnd = new Date(today);
        todayEnd.setHours(23, 59, 59, 999);

        // Calculate total income from sales orders made today
        var todayTotalIncome = manualSales
          .filter(function(order) {
            if (!order.ordered_at) return false;
            var orderDate = new Date(order.ordered_at);
            return orderDate >= today && orderDate <= todayEnd;
          })
          .reduce(function(total, order) {
            var orderTotal = parseFloat(order.total_amount || 0) || 0;
            return total + orderTotal;
          }, 0);

        // Format as currency
        salesTodayCountEl.textContent = '‚Ç±' + todayTotalIncome.toLocaleString('en-US', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }

      // Update product quantity
      window.updateQuantity = function(productId, change){
        if (!canEditInventory) {
          alert('You do not have permission to update inventory quantities.');
          return;
        }
        var product = getProductById(productId);
        if (product) {
          var oldStock = getDisplayStock(product);
          var newStock = Math.max(0, oldStock + change);
          setPendingStockValue(productId, newStock);
          
          // Update the input field value
          var qtyInput = document.getElementById('qty-' + productId);
          if (qtyInput) {
            qtyInput.value = newStock;
          }
          
          // Check if stock crossed threshold and show notification
          // Use product's individual low_stock_threshold, or default to 5 if not set
          var productThreshold = product.low_stock_threshold || product.lowStockThreshold || 5;
          var wasLowStock = oldStock > 0 && oldStock <= productThreshold;
          var isLowStock = newStock > 0 && newStock <= productThreshold;
          
          if (wasLowStock && !isLowStock && change > 0) {
            showLowStockNotification(product.name + ' has been restocked above threshold!', 'success');
          } else if (!wasLowStock && isLowStock && change < 0) {
            showLowStockNotification(product.name + ' is now running low on stock!', 'warning');
          }
          
          updateInventoryStats();
          updateLowStockAlerts();
        }
      };
      
      // Save product changes with reason
      window.saveProductChanges = function(productId) {
        if (!canEditInventory) {
          alert('You do not have permission to save product changes.');
          return;
        }
        
        var product = products.find(p => p.id === productId);
        if (!product) {
          alert('Product not found.');
          return;
        }
        
        // Get current stock from input field
        var qtyInput = document.getElementById('qty-' + productId);
        var newStock = qtyInput ? parseInt(qtyInput.value) : product.stock;
        
        if (isNaN(newStock) || newStock < 0) {
          alert('Please enter a valid stock quantity.');
          return;
        }
        
        var originalStock = originalProductStock[productId] || product.stock;
        var stockChange = newStock - originalStock;
        
        if (stockChange === 0) {
          alert('No changes to save.');
          return;
        }
        
        // Generate a transaction ID for this save so the server can block duplicates
        var movementTransactionId = 'inv-' + Date.now() + '-' + productId + '-' + Math.random().toString(36).substring(2, 8);

        // Track modal submission to prevent duplicate writes / spam (debounce)
        var isSavingReason = false;
        var lastReasonConfirmTime = 0;
        var resetReasonModalState = function() {
          isSavingReason = false;
          if (confirmReasonBtn) {
            confirmReasonBtn.disabled = false;
            confirmReasonBtn.textContent = 'Confirm';
          }
        };

        // Show custom modal for reason input
        var reasonModal = document.getElementById('reason-input-modal');
        var reasonInput = document.getElementById('reason-input');
        var confirmReasonBtn = document.getElementById('confirm-reason-btn');
        var cancelReasonBtn = document.getElementById('cancel-reason-btn');
        var closeReasonModalBtn = document.getElementById('close-reason-modal');
        
        if (!reasonModal || !reasonInput) {
          alert('Reason input modal not found. Please refresh the page.');
          return;
        }
        
        // Set default value based on stock change
        reasonInput.value = stockChange > 0 ? 'restock' : 'adjustment';
        reasonInput.focus();
        reasonInput.select();
        
        // Show modal
        reasonModal.style.display = 'flex';
        
        // Function to continue with save after reason is provided
        var continueWithSave = function(validReason) {
          if (!validReason) {
            return; // User cancelled
          }
        
          // Extract database product ID
        var dbProductId = productId.toString().startsWith('p') ? productId.toString().substring(1) : productId;
        var numericProductId = parseInt(dbProductId, 10);
        if (isNaN(numericProductId)) {
          alert('Unable to determine database ID for this product.');
          return;
        }
        
        // First, get the product from database to get category_id
        fetch(API_BASE_URL + '/api/products/' + numericProductId)
          .then(function(response) {
            return response.json();
          })
          .then(function(dbProduct) {
            // Get category_id from database product or look it up
            var categoryId = dbProduct.category_id;
            
            // If no category_id, try to get it from category name
            if (!categoryId && product.category) {
              return fetch(API_BASE_URL + '/api/categories')
                .then(function(response) {
                  return response.json();
                })
                .then(function(categories) {
                  var foundCategory = categories.find(function(cat) {
                    return cat.name === product.category;
                  });
                  return foundCategory ? foundCategory.id : null;
                });
            }
            return categoryId;
          })
          .then(function(categoryId) {
            // Update product in database
            return fetch(API_BASE_URL + '/api/products/' + numericProductId, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                name: product.name,
                brand: product.brand,
                category_id: categoryId,
                size: product.size,
                condition_grade: product.condition || 'New',
                retail_price: product.price,
                original_price: product.originalPrice || null,
                stock_quantity: newStock,
                low_stock_threshold: 5
              })
            });
          })
          .then(function(response) {
            return response.json().then(function(data) {
              if (!response.ok) {
                throw new Error(data.error || 'Failed to update product');
              }
              return data;
            });
          })
        .then(function(result) {
          // Log inventory movement
          // Get current user ID for created_by field
          var userId = currentUser && currentUser.id ? currentUser.id : null;
          var numericUserId = userId && userId.toString().startsWith('p')
            ? userId.toString().substring(1)
            : userId;

          return fetch(API_BASE_URL + '/api/inventory/movements', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              product_id: numericProductId,
              change_qty: stockChange,
              reason: validReason,
              reference_type: 'manual_update',
              reference_id: productId,
              transaction_id: movementTransactionId,
              created_by: numericUserId || null
            })
          });
        })
        .then(function(response) {
          return response.json();
        })
        .then(function() {
          // Update local product
          product.stock = newStock;
          originalProductStock[productId] = newStock;
          delete pendingStockChanges[productId];
          syncRowDirtyState(productId);
          updateUnsavedState();
          // Best-effort cache update; ignore quota errors
          try {
            localStorage.setItem('products', JSON.stringify(products));
          } catch (storageError) {
            console.warn('‚ö†Ô∏è Unable to update products in localStorage (quota exceeded).', storageError);
          }
          
          // Refresh inventory and history
          renderInventory();
          renderProductHistory(true); // Force refresh to show new entry
          
          alert('Product changes saved successfully!');
        })
          .catch(function(error) {
          console.error('Error saving product:', error);
          alert('Error saving product: ' + error.message);
        })
        .finally(function() {
          resetReasonModalState();
        });
        };
        
        // Set up event handlers for reason modal
        var handleReasonConfirm = function() {
          var now = Date.now();
          // Debounce: ignore confirmations within 800ms of the last one
          if (now - lastReasonConfirmTime < 800) {
            return;
          }
          lastReasonConfirmTime = now;

          if (isSavingReason) {
            return; // Ignore if already saving
          }
          
          // Lock immediately so double-clicks / key spam can't fire twice
          isSavingReason = true;
          if (confirmReasonBtn) {
            confirmReasonBtn.disabled = true;
            confirmReasonBtn.textContent = 'Saving...';
          }
          reasonModal.style.display = 'none';

          var reasonText = reasonInput.value.trim();
          if (!reasonText) {
            // If no reason, unlock and show modal again
            alert('Please provide a reason for this change.');
            resetReasonModalState();
            reasonModal.style.display = 'flex';
            reasonInput.focus();
            reasonInput.select();
            return;
          }

          continueWithSave(reasonText); // Use the exact text entered by user
        };
        
        var handleReasonCancel = function() {
          // Hide modal
          reasonModal.style.display = 'none';
          resetReasonModalState();

          // Revert attempted changes: reset quantity back to original value
          if (qtyInput) {
            qtyInput.value = originalStock;
          }

          // Clear any pending stock change for this product
          if (pendingStockChanges && Object.prototype.hasOwnProperty.call(pendingStockChanges, productId)) {
            delete pendingStockChanges[productId];
          }

          // Sync row state and unsaved banner
          if (typeof syncRowDirtyState === 'function') {
            syncRowDirtyState(productId);
          }
          if (typeof updateUnsavedState === 'function') {
            updateUnsavedState();
          }
        };
        
        // Remove existing listeners to prevent duplicates
        var newConfirmBtn = confirmReasonBtn.cloneNode(true);
        confirmReasonBtn.parentNode.replaceChild(newConfirmBtn, confirmReasonBtn);
        confirmReasonBtn = newConfirmBtn;
        
        var newCancelBtn = cancelReasonBtn.cloneNode(true);
        cancelReasonBtn.parentNode.replaceChild(newCancelBtn, cancelReasonBtn);
        cancelReasonBtn = newCancelBtn;
        
        var newCloseBtn = closeReasonModalBtn.cloneNode(true);
        closeReasonModalBtn.parentNode.replaceChild(newCloseBtn, closeReasonModalBtn);
        closeReasonModalBtn = newCloseBtn;
        
        confirmReasonBtn.addEventListener('click', handleReasonConfirm);
        cancelReasonBtn.addEventListener('click', handleReasonCancel);
        closeReasonModalBtn.addEventListener('click', handleReasonCancel);
        
        // Allow Enter key to confirm
        reasonInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleReasonConfirm();
          }
        });
        
        // Close modal when clicking outside
        reasonModal.addEventListener('click', function(e) {
          if (e.target === reasonModal) {
            handleReasonCancel();
          }
        });
      };
      
      // Show low stock / floating notification
      function showLowStockNotification(message, type) {
        var notification = document.createElement('div');
        notification.className = 'low-stock-notification ' + (type || 'info');
        notification.innerHTML = `
          <div class="notification-content">
            <span class="notification-icon">${type === 'success' ? '‚úÖ' : type === 'info' ? '‚ÑπÔ∏è' : '‚ö†Ô∏è'}</span>
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(function() {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 5000);
      }

      // Override default alert() with floating notification window
      (function() {
        var nativeAlert = window.alert;
        window.alert = function(message) {
          try {
            if (typeof showLowStockNotification === 'function') {
              showLowStockNotification(String(message || ''), 'info');
            } else if (typeof nativeAlert === 'function') {
              nativeAlert(message);
            }
          } catch (e) {
            if (typeof nativeAlert === 'function') {
              nativeAlert(message);
            }
          }
        };
      })();
      
      // Show sales notification in Inventory section
      function showSalesNotification(saleResult) {
        var salesBanner = document.getElementById('sales-notification-banner');
        var salesMessage = document.getElementById('sales-notification-message');
        
        if (!salesBanner || !salesMessage) return;
        
        // Get product name from sale result or items
        var productName = 'Product';
        var totalAmount = saleResult.total_amount ? parseFloat(saleResult.total_amount).toFixed(2) : '0.00';
        
        if (saleResult.items && saleResult.items.length > 0) {
          productName = saleResult.items[0].product_name || 'Product';
        }
        
        // Update message
        salesMessage.textContent = productName + ' sold for ‚Ç±' + totalAmount;
        
        // Show banner
        salesBanner.style.display = 'block';
        
        // Auto-hide after 8 seconds
        setTimeout(function() {
          if (salesBanner) {
            salesBanner.style.display = 'none';
          }
        }, 8000);
      }

      var profileForm = document.getElementById('admin-profile-form');
      var profileResetBtn = document.getElementById('profile-reset-btn');

      // Profile picture management
      var profilePictureInput = document.getElementById('profile-picture');
      var profilePictureUploadBtn = document.getElementById('profile-picture-upload-btn');
      var profilePicturePreview = document.getElementById('profile-picture-preview-img');
      var profilePictureDisplay = document.getElementById('profile-picture-display');
      var profilePictureEditIcon = document.getElementById('profile-picture-edit-icon');
      var profileDisplayName = document.getElementById('profile-display-name');
      var profileDisplayRole = document.getElementById('profile-display-role');
      var uploadedProfilePicture = null;

      function loadProfilePicture() {
        if (!currentUser) return;
        var userId = currentUser.id || currentUser.email;
        var savedPicture = localStorage.getItem('profile_picture_' + userId);
        if (savedPicture) {
          if (profilePictureDisplay) profilePictureDisplay.src = savedPicture;
          if (profilePicturePreview) {
            profilePicturePreview.src = savedPicture;
            profilePicturePreview.style.display = 'block';
          }
        }
      }

      function saveProfilePicture(imageData) {
        if (!currentUser) return;
        var userId = currentUser.id || currentUser.email;
        try {
          localStorage.setItem('profile_picture_' + userId, imageData);
          if (profilePictureDisplay) profilePictureDisplay.src = imageData;
          if (profilePicturePreview) {
            profilePicturePreview.src = imageData;
            profilePicturePreview.style.display = 'block';
          }
        } catch (e) {
          console.warn('Failed to save profile picture:', e);
          alert('Profile picture is too large. Please use a smaller image.');
        }
      }

      if (profilePictureUploadBtn && profilePictureInput) {
        profilePictureUploadBtn.addEventListener('click', function() {
          profilePictureInput.click();
        });
      }

      if (profilePictureEditIcon) {
        profilePictureEditIcon.addEventListener('click', function() {
          if (profilePictureInput) profilePictureInput.click();
        });
      }

      if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (!file) return;

          // Validate file type
          if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file (JPG, PNG, GIF, etc.)');
            return;
          }

          // Validate file size (2MB limit)
          if (file.size > 2 * 1024 * 1024) {
            alert('Image file is too large. Maximum size is 2MB.');
            return;
          }

          // Convert to base64
          var reader = new FileReader();
          reader.onload = function(e) {
            var base64String = e.target.result;
            uploadedProfilePicture = base64String;
            if (profilePicturePreview) {
              profilePicturePreview.src = base64String;
              profilePicturePreview.style.display = 'block';
            }
          };
          reader.onerror = function() {
            alert('Error reading image file');
          };
          reader.readAsDataURL(file);
        });
      }

      function populateProfileSection(){
        if (!currentUser) return;
        var roleLabel = roleMap[currentUser.role] ? roleMap[currentUser.role].label : currentUser.role;
        var summaryName = document.getElementById('profile-summary-name');
        var summaryEmail = document.getElementById('profile-summary-email');
        var summaryRole = document.getElementById('profile-summary-role');
        var summaryPhone = document.getElementById('profile-summary-phone');
        var summaryLastLogin = document.getElementById('profile-summary-last-login');
        if (summaryName) summaryName.textContent = currentUser.name || '‚Äî';
        if (summaryEmail) summaryEmail.textContent = currentUser.email || '‚Äî';
        if (summaryRole) summaryRole.textContent = roleLabel;
        if (summaryPhone) summaryPhone.textContent = currentUser.phone || '‚Äî';
        if (summaryLastLogin) summaryLastLogin.textContent = adminSession.issuedAt ? new Date(adminSession.issuedAt).toLocaleString() : 'Just now';

        // Update display name and role
        if (profileDisplayName) profileDisplayName.textContent = currentUser.name || '‚Äî';
        if (profileDisplayRole) profileDisplayRole.textContent = roleLabel;

        // Load profile picture
        loadProfilePicture();

        var profileNameInput = document.getElementById('profile-name');
        var profileEmailInput = document.getElementById('profile-email');
        var profilePhoneInput = document.getElementById('profile-phone');
        var profileNewPassword = document.getElementById('profile-new-password');
        var profileConfirmPassword = document.getElementById('profile-confirm-password');

        if (profileNameInput) profileNameInput.value = currentUser.name || '';
        if (profileEmailInput) profileEmailInput.value = currentUser.email || '';
        if (profilePhoneInput) profilePhoneInput.value = currentUser.phone || '';
        // Clear password fields
        if (profileNewPassword) profileNewPassword.value = '';
        if (profileConfirmPassword) profileConfirmPassword.value = '';
      }

      function gateProfileForm(){
        if (!profileForm) return;
        if (!canEditProfile) {
          var inputs = profileForm.querySelectorAll('input, select, button');
          inputs.forEach(function(el){
            if (el && el.type !== 'reset') el.disabled = true;
          });
          if (!profileForm.querySelector('.form-note')) {
            var notice = document.createElement('p');
            notice.className = 'form-note';
            notice.textContent = 'Profile editing is disabled for your role.';
            profileForm.appendChild(notice);
          }
        }
      }

      if (profileForm) {
        profileForm.addEventListener('submit', function(e){
          e.preventDefault();
          if (!canEditProfile) return;
          
          var name = (document.getElementById('profile-name').value || '').trim();
          var phone = (document.getElementById('profile-phone').value || '').trim();
          var newPassword = document.getElementById('profile-new-password').value;
          var confirmPassword = document.getElementById('profile-confirm-password').value;
          
          if (!name) {
            alert('Name cannot be empty.');
            return;
          }
          
          // Check if password change is requested (both fields must be filled)
          var passwordChangeRequested = newPassword && confirmPassword;
          if (passwordChangeRequested) {
            if (newPassword.length < 6) {
              alert('New password must be at least 6 characters long.');
              return;
            }
            if (newPassword !== confirmPassword) {
              alert('New password and confirm password do not match.');
              return;
            }
          } else if (newPassword || confirmPassword) {
            // If only one password field is filled, show error
            alert('To change password, please fill in both New Password and Confirm Password fields.');
            return;
          }
          
          var payload = {
            name: name,
            phone: phone
          };
          
          // Add password if changing (hash it first)
          if (passwordChangeRequested && newPassword) {
            // Hash the password using the auth module's hashPassword function
            payload.password = auth.hashPassword(newPassword);
          }
          
          try {
            var updated = auth.updateUserProfile(currentUser.id, payload);
            currentUser = updated;
            adminSession.user = updated;
            if (window.AdminContext) window.AdminContext.user = updated;
            
            // Save profile picture if uploaded
            var pictureUpdated = false;
            if (uploadedProfilePicture) {
              saveProfilePicture(uploadedProfilePicture);
              pictureUpdated = true;
              uploadedProfilePicture = null; // Reset after saving
            }
            
            populateProfileSection();
            var headerName = document.getElementById('current-user-name');
            if (headerName) headerName.textContent = updated.name;
            
            var message = 'Profile updated successfully.';
            if (passwordChangeRequested) {
              message += ' Password has been changed.';
            }
            if (pictureUpdated) {
              message += ' Profile picture has been updated.';
            }
            alert(message);
          } catch(err) {
            alert(err.message || 'Unable to update profile.');
          }
        });
      }

      if (profileResetBtn) {
        profileResetBtn.addEventListener('click', function(e){
          e.preventDefault();
          populateProfileSection();
        });
      }

      // Render reservations
      function renderReservations(){
        var tbody = document.getElementById('reservations-table-body');
        if (!tbody) return;

        if (reservations.length === 0){
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#6b7280;">No reservations found</td></tr>';
          // Update stats to 0
          document.getElementById('total-reservations').textContent = '0';
          document.getElementById('pending-reservations').textContent = '0';
          document.getElementById('confirmed-reservations').textContent = '0';
          document.getElementById('declined-reservations').textContent = '0';
          document.getElementById('cancelled-reservations').textContent = '0';
          return;
        }

        tbody.innerHTML = '';
        reservations.forEach(function(reservation){
          var row = document.createElement('tr');
          var statusClass = reservation.status.toLowerCase().replace(' ', '-');
          
          // Format customer name
          var customerName = (reservation.first_name || '') + ' ' + (reservation.last_name || '');
          customerName = customerName.trim() || reservation.customer_email || 'Unknown Customer';
          
          // Format created by info
          var createdByInfo = '';
          if (reservation.created_by_name) {
            createdByInfo = '<div style="font-size: 0.85rem; color: #6b7280;">Created by: ' + reservation.created_by_name + '</div>';
          } else if (reservation.created_by_username) {
            createdByInfo = '<div style="font-size: 0.85rem; color: #6b7280;">Created by: ' + reservation.created_by_username + '</div>';
          }
          
          // Format date
          var reservedDate = reservation.reserved_at ? new Date(reservation.reserved_at) : new Date();
          var dateStr = reservedDate.toLocaleDateString();
          var timeStr = reservedDate.toLocaleTimeString();
          
          // Product image
          var productImage = reservation.image_url || DEFAULT_PRODUCT_IMAGE;
          
          row.innerHTML = `
            <td>
              <img src="${productImage}" alt="${reservation.product_name || 'Product'}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
            </td>
            <td>
              <div style="font-weight: 600; margin-bottom: 4px;">${reservation.product_name || 'Unknown Product'}</div>
              <div style="font-size: 0.85rem; color: #6b7280;">ID: ${reservation.product_id}</div>
            </td>
            <td>
              <div style="font-weight: 600;">${customerName}</div>
              ${createdByInfo}
            </td>
            <td style="font-weight: 600; color: #dc2626;">‚Ç±${parseFloat(reservation.reserved_price || 0).toFixed(2)}</td>
            <td>
              <div>${dateStr}</div>
              <div style="font-size: 0.85rem; color: #6b7280;">${timeStr}</div>
            </td>
            <td><span class="badge ${statusClass}">${reservation.status}</span></td>
            <td>
              ${reservation.status === 'Pending' ? 
                '<button class="btn-small btn-secondary" onclick="confirmReservation(\'' + reservation.id + '\')" style="margin-right: 8px;">‚úì Confirm</button>' +
                '<button class="btn-small btn-danger" onclick="declineReservation(\'' + reservation.id + '\')" style="margin-right: 8px;">‚úó Decline</button>' +
                '<button class="btn-small btn-warning" onclick="cancelReservation(\'' + reservation.id + '\')">‚õî Cancel</button>' :
                reservation.status === 'Confirmed' ?
                '<button class="btn-small btn-warning" onclick="cancelReservation(\'' + reservation.id + '\')">‚õî Cancel</button>' :
                '<span class="text-muted">No actions</span>'
              }
            </td>
          `;
          tbody.appendChild(row);
        });

        // Update stats
        var total = reservations.length;
        var pending = reservations.filter(r => r.status === 'Pending').length;
        var confirmed = reservations.filter(r => r.status === 'Confirmed').length;
        var declined = reservations.filter(r => r.status === 'Declined').length;
        var cancelled = reservations.filter(r => r.status === 'Cancelled').length;

        document.getElementById('total-reservations').textContent = total;
        document.getElementById('pending-reservations').textContent = pending;
        document.getElementById('confirmed-reservations').textContent = confirmed;
        document.getElementById('declined-reservations').textContent = declined;
        document.getElementById('cancelled-reservations').textContent = cancelled;
      }

      // Confirm reservation
      window.confirmReservation = function(reservationId){
        var reservation = reservations.find(r => r.id == reservationId);
        if (!reservation) {
          alert('Reservation not found');
          return;
        }
        
        fetch(API_BASE_URL + '/api/reservations/' + reservationId + '/status', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'Confirmed' })
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to update reservation');
          }
          return response.json();
        })
        .then(function() {
          // Reload reservations from server
          loadReservationsFromServer().then(function() {
            renderCharts();
            alert('Reservation confirmed successfully!');
          });
        })
        .catch(function(error) {
          console.error('Error confirming reservation:', error);
          alert('Failed to confirm reservation: ' + error.message);
        });
      };

      // Decline reservation
      window.declineReservation = function(reservationId){
        var reservation = reservations.find(r => r.id == reservationId);
        if (!reservation) {
          alert('Reservation not found');
          return;
        }
        
        if (!confirm('Are you sure you want to decline this reservation?')) {
          return;
        }
        
        fetch(API_BASE_URL + '/api/reservations/' + reservationId + '/status', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'Declined' })
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to update reservation');
          }
          return response.json();
        })
        .then(function() {
          // Reload reservations from server
          loadReservationsFromServer().then(function() {
            renderCharts();
            alert('Reservation declined successfully!');
          });
        })
        .catch(function(error) {
          console.error('Error declining reservation:', error);
          alert('Failed to decline reservation: ' + error.message);
        });
      };

      // Cancel reservation
      window.cancelReservation = function(reservationId){
        var reservation = reservations.find(r => r.id == reservationId);
        if (!reservation) {
          alert('Reservation not found');
          return;
        }
        
        if (!confirm('Are you sure you want to cancel this reservation?')) {
          return;
        }
        
        fetch(API_BASE_URL + '/api/reservations/' + reservationId + '/status', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'Cancelled' })
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to update reservation');
          }
          return response.json();
        })
        .then(function() {
          // Reload reservations from server
          loadReservationsFromServer().then(function() {
            renderCharts();
            alert('Reservation cancelled successfully!');
          });
        })
        .catch(function(error) {
          console.error('Error cancelling reservation:', error);
          alert('Failed to cancel reservation: ' + error.message);
        });
      };

      // Get current timeframe for sales
      function getCurrentSalesTimeframe(){
        var activeTab = document.querySelector('#sales .tab.active');
        return activeTab ? activeTab.getAttribute('data-timeframe') : 'daily';
      }

      // Load sales data from database
      function loadSalesData(timeframe) {
        return fetch(API_BASE_URL + '/api/sales/statistics?timeframe=' + timeframe)
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Failed to fetch sales data');
            }
            return response.json();
          })
          .then(function(data) {
            // Update sales cards
            var revenueCard = document.querySelector('#sales .card:first-child span');
            var salesCard = document.querySelector('#sales .card:last-child span');
            if (revenueCard) revenueCard.textContent = '‚Ç±' + parseFloat(data.totalRevenue || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (salesCard) salesCard.textContent = (data.totalSales || 0).toLocaleString();
            
            return data;
          })
          .catch(function(error) {
            console.error('Error loading sales data:', error);
            // Return empty data on error
            return {
              totalRevenue: 0,
              totalSales: 0,
              topProducts: { labels: [], data: [] },
              categories: { labels: [], data: [] },
              salesTrend: { labels: [], data: [] },
              reservationStatus: { labels: ['Pending', 'Confirmed', 'Declined', 'Cancelled'], data: [0, 0, 0, 0] }
            };
          });
      }
      
      // Get chart data based on timeframe (now loads from API)
      function getChartData(timeframe){
        // This will be populated by loadSalesData, return placeholder for now
        return {
          topProducts: { labels: [], data: [] },
          categories: { labels: [], data: [] },
          salesTrend: { labels: [], data: [] },
          reservationStatus: { labels: ['Pending', 'Confirmed', 'Declined', 'Cancelled'], data: [0, 0, 0, 0] }
        };
      }

      // Render charts
      function renderCharts(){
        var timeframe = getCurrentSalesTimeframe();
        
        // Update sales trend title based on timeframe
        var salesTrendTitle = document.getElementById('sales-trend-title');
        if (salesTrendTitle) {
          var titleMap = {
            'daily': 'Daily Sales Trend',
            'weekly': 'Weekly Sales Trend',
            'monthly': 'Monthly Sales Trend',
            'yearly': 'Yearly Sales Trend'
          };
          salesTrendTitle.textContent = titleMap[timeframe] || 'Sales Trend';
        }
        
        // Load data from API first
        loadSalesData(timeframe).then(function(salesData) {
          // Destroy existing charts
          Chart.helpers.each(Chart.instances, function(instance) {
            instance.destroy();
          });
          
          var chartData = {
            topProducts: salesData.topProducts,
            categories: salesData.categories,
            salesTrend: salesData.salesTrend,
            reservationStatus: salesData.reservationStatus
          };
          
          // Render sold items list
          renderSoldItems(timeframe);

        // Top Products Chart
        var topProductsCtx = document.getElementById('topProductsChart');
        if (topProductsCtx) {
          new Chart(topProductsCtx, {
            type: 'bar',
            data: {
              labels: chartData.topProducts.labels,
              datasets: [{
                label: 'Sales Count',
                data: chartData.topProducts.data,
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        }

        // Category Chart
        var categoryCtx = document.getElementById('categoryChart');
        if (categoryCtx) {
          new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
              labels: chartData.categories.labels,
              datasets: [{
                data: chartData.categories.data,
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
              }]
            },
            options: {
              responsive: true
            }
          });
        }

        // Sales Trend Chart
        var salesTrendCtx = document.getElementById('salesTrendChart');
        if (salesTrendCtx) {
          new Chart(salesTrendCtx, {
            type: 'line',
            data: {
              labels: chartData.salesTrend.labels,
              datasets: [{
                label: 'Sales (‚Ç±)',
                data: chartData.salesTrend.data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        }

        // Reservation Status Chart
        var reservationStatusCtx = document.getElementById('reservationStatusChart');
        if (reservationStatusCtx) {
          new Chart(reservationStatusCtx, {
            type: 'pie',
            data: {
              labels: chartData.reservationStatus.labels,
              datasets: [{
                data: chartData.reservationStatus.data,
                backgroundColor: ['#f59e0b', '#10b981', '#ef4444', '#6b7280']
              }]
            },
            options: {
              responsive: true
            }
          });
        }
      });
      }
      
      // Render sold items list
      function renderSoldItems(timeframe) {
        var tbody = document.getElementById('sold-items-table-body');
        var countSpan = document.getElementById('sold-items-count');
        var timeframeLabel = document.getElementById('sold-items-timeframe-label');
        
        if (!tbody) return;
        
        // Update timeframe label
        if (timeframeLabel) {
          var labelMap = {
            'daily': 'today',
            'weekly': 'this week',
            'monthly': 'this month',
            'yearly': 'this year'
          };
          timeframeLabel.textContent = labelMap[timeframe] || 'this period';
        }
        
        // Filter confirmed reservations by timeframe
        var now = new Date();
        var filteredReservations = reservations.filter(function(res) {
          if (res.status !== 'Confirmed') return false;
          
          var reservedDate = new Date(res.reserved_at);
          var dateFilter = true;
          
          switch(timeframe) {
            case 'daily':
              dateFilter = reservedDate.toDateString() === now.toDateString();
              break;
            case 'weekly':
              var weekAgo = new Date(now);
              weekAgo.setDate(weekAgo.getDate() - 7);
              dateFilter = reservedDate >= weekAgo;
              break;
            case 'monthly':
              var monthAgo = new Date(now);
              monthAgo.setMonth(monthAgo.getMonth() - 1);
              dateFilter = reservedDate >= monthAgo;
              break;
            case 'yearly':
              var yearAgo = new Date(now);
              yearAgo.setFullYear(yearAgo.getFullYear() - 1);
              dateFilter = reservedDate >= yearAgo;
              break;
          }
          
          return dateFilter;
        });
        
        // Sort by date (newest first)
        filteredReservations.sort(function(a, b) {
          return new Date(b.reserved_at) - new Date(a.reserved_at);
        });
        
        // Update count
        if (countSpan) {
          countSpan.textContent = filteredReservations.length + ' item' + (filteredReservations.length !== 1 ? 's' : '');
        }
        
        // Render table
        if (filteredReservations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #6b7280;">No sold items for ' + (timeframeLabel ? timeframeLabel.textContent : 'this period') + '</td></tr>';
          return;
        }
        
        tbody.innerHTML = '';
        filteredReservations.forEach(function(reservation) {
          var row = document.createElement('tr');
          row.style.borderBottom = '1px solid #e5e7eb';
          
          // Format customer name
          var customerName = '';
          if (reservation.first_name || reservation.last_name) {
            customerName = (reservation.first_name || '') + ' ' + (reservation.last_name || '');
            customerName = customerName.trim();
          }
          if (!customerName && reservation.customer_email) {
            customerName = reservation.customer_email;
          }
          if (!customerName) {
            customerName = 'Unknown Customer';
          }
          
          // Format date
          var reservedDate = reservation.reserved_at ? new Date(reservation.reserved_at) : new Date();
          var dateStr = reservedDate.toLocaleDateString();
          var timeStr = reservedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          
          // Product image
          var productImage = reservation.image_url || DEFAULT_PRODUCT_IMAGE;
          
          row.innerHTML = `
            <td style="padding: 12px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <img src="${productImage}" alt="${reservation.product_name || 'Product'}" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;" 
                     onerror="this.onerror=null;this.src='${DEFAULT_PRODUCT_IMAGE}';">
                <div>
                  <div style="font-weight: 600; color: #111827; margin-bottom: 4px;">${reservation.product_name || 'Unknown Product'}</div>
                  <div style="font-size: 0.85rem; color: #6b7280;">ID: ${reservation.product_id || 'N/A'}</div>
                </div>
              </div>
            </td>
            <td style="padding: 12px;">
              <div style="font-weight: 500; color: #111827;">${customerName}</div>
              ${reservation.customer_email ? '<div style="font-size: 0.85rem; color: #6b7280;">' + reservation.customer_email + '</div>' : ''}
            </td>
            <td style="padding: 12px; text-align: right; font-weight: 600; color: #059669;">
              ‚Ç±${parseFloat(reservation.reserved_price || 0).toFixed(2)}
            </td>
            <td style="padding: 12px;">
              <div style="font-weight: 500; color: #111827;">${dateStr}</div>
              <div style="font-size: 0.85rem; color: #6b7280;">${timeStr}</div>
            </td>
            <td style="padding: 12px;">
              <div style="font-family: monospace; font-size: 0.9rem; color: #6b7280;">${reservation.reservation_code || 'N/A'}</div>
            </td>
          `;
          tbody.appendChild(row);
        });
      }

      // Add Product Modal functionality
      var addProductBtn = document.getElementById('add-product-btn');
      var addProductModal = document.getElementById('add-product-modal');
      var closeModal = document.getElementById('close-modal');
      var cancelAdd = document.getElementById('cancel-add');
      var addProductForm = document.getElementById('add-product-form');
      var imageInput = document.getElementById('product-image');
      var imagePreview = document.getElementById('image-preview');
      var chooseFileBtn = document.getElementById('choose-file-btn');
      var cameraBtn = document.getElementById('camera-btn');
      var manualSaleModal = document.getElementById('manual-sale-modal');
      var manualSaleForm = document.getElementById('manual-sale-form');
      var manualSaleProductIdInput = document.getElementById('manual-sale-product-id');
      var manualSaleProductLabel = document.getElementById('manual-sale-product-label');
      var manualSaleQuantityInput = document.getElementById('manual-sale-quantity');
      var manualSalePriceInput = document.getElementById('manual-sale-price');
      var manualSaleStockLabel = document.getElementById('manual-sale-stock-info');
      var manualSaleTotalEl = document.getElementById('manual-sale-total');
      var manualSaleAmountPaidInput = document.getElementById('manual-sale-amount-paid');
      var manualSaleChangeEl = document.getElementById('manual-sale-change');
      var manualSaleCloseBtn = document.getElementById('close-manual-sale-modal');
      var manualSaleCancelBtn = document.getElementById('cancel-manual-sale');
      var manualSalesTableBody = document.getElementById('sales-manual-sales-table-body');
      var salesTimeframeFilter = document.getElementById('sales-timeframe-filter');
      var salesMonthFilter = document.getElementById('sales-month-filter');
      var salesYearFilter = document.getElementById('sales-year-filter');
      var salesCategoryFilter = document.getElementById('sales-category-filter');
      var salesTotalAmountEl = document.getElementById('sales-total-amount');
      var manualSales = [];
      var salesEntryGrid = document.getElementById('sales-entry-product-grid');
      var uploadedImagePath = null; // Used for add product uploads
      var uploadedEditImagePath = null; // Used for edit product uploads
      
      function openManualSaleModal(product) {
        if (!manualSaleModal) return;
        var stock = getDisplayStock(product);
        manualSaleProductIdInput.value = product.id;
        manualSaleProductLabel.textContent = product.name + (product.brand ? ' ‚Ä¢ ' + product.brand : '');
        manualSaleQuantityInput.value = 1;
        // Default to retail price
        manualSalePriceInput.value = product.price || 0;
        
        // Reset button states - Retail is default/active
        var useRetailPriceBtn = document.getElementById('use-retail-price-btn');
        var useWholesalePriceBtn = document.getElementById('use-wholesale-price-btn');
        if (useRetailPriceBtn) {
          useRetailPriceBtn.classList.remove('btn-secondary');
          useRetailPriceBtn.classList.add('btn');
        }
        if (useWholesalePriceBtn) {
          useWholesalePriceBtn.classList.remove('btn');
          useWholesalePriceBtn.classList.add('btn-secondary');
        }
        
        if (manualSaleStockLabel) {
          manualSaleStockLabel.textContent = 'Stock: ' + (stock ?? 0);
        }
        updateManualSaleTotal();
        // Auto-fill amount paid with total
        if (manualSaleAmountPaidInput && manualSaleTotalEl) {
          var totalText = manualSaleTotalEl.textContent.replace('‚Ç±', '').replace(/,/g, '');
          var total = parseFloat(totalText) || 0;
          manualSaleAmountPaidInput.value = total > 0 ? total.toFixed(2) : '';
          updateChange();
        }
        manualSaleModal.style.display = 'flex';
      }

      function closeManualSaleModal() {
        if (manualSaleModal) {
          manualSaleModal.style.display = 'none';
        }
        if (manualSaleForm) {
          manualSaleForm.reset();
        }
        if (manualSaleStockLabel) {
          manualSaleStockLabel.textContent = 'Stock: ‚Äî';
        }
        if (manualSaleTotalEl) {
          manualSaleTotalEl.textContent = '‚Ç±0.00';
        }
        if (manualSaleAmountPaidInput) {
          manualSaleAmountPaidInput.value = '';
        }
        if (manualSaleChangeEl) {
          manualSaleChangeEl.textContent = '‚Ç±0.00';
          manualSaleChangeEl.style.color = '#374151';
          manualSaleChangeEl.style.background = '#f3f4f6';
        }
      }

      function updateManualSaleTotal() {
        if (!manualSaleQuantityInput || !manualSalePriceInput || !manualSaleTotalEl) return;
        var qty = parseInt(manualSaleQuantityInput.value || '0', 10);
        var price = parseFloat(manualSalePriceInput.value || '0');
        if (isNaN(qty) || isNaN(price)) {
          manualSaleTotalEl.textContent = '‚Ç±0.00';
          updateChange();
          return;
        }
        var total = qty * price;
        manualSaleTotalEl.textContent = '‚Ç±' + total.toFixed(2);
        updateChange();
      }

      function updateChange() {
        if (!manualSaleTotalEl || !manualSaleAmountPaidInput || !manualSaleChangeEl) return;
        var totalText = manualSaleTotalEl.textContent.replace('‚Ç±', '').replace(/,/g, '');
        var total = parseFloat(totalText) || 0;
        var amountPaid = parseFloat(manualSaleAmountPaidInput.value || '0') || 0;
        var change = amountPaid - total;
        
        if (change < 0) {
          manualSaleChangeEl.textContent = '‚Ç±' + Math.abs(change).toFixed(2) + ' (Insufficient)';
          manualSaleChangeEl.style.color = '#dc2626';
          manualSaleChangeEl.style.background = '#fee2e2';
        } else {
          manualSaleChangeEl.textContent = '‚Ç±' + change.toFixed(2);
          manualSaleChangeEl.style.color = change > 0 ? '#059669' : '#374151';
          manualSaleChangeEl.style.background = change > 0 ? '#d1fae5' : '#f3f4f6';
        }
      }

      if (manualSaleQuantityInput) {
        manualSaleQuantityInput.addEventListener('input', updateManualSaleTotal);
      }
      // Remove input event listener since price is now read-only
      // Price will be set by Retail/Wholesale buttons only
      
      // Retail Price button
      var useRetailPriceBtn = document.getElementById('use-retail-price-btn');
      var useWholesalePriceBtn = document.getElementById('use-wholesale-price-btn');
      
      if (useRetailPriceBtn) {
        useRetailPriceBtn.addEventListener('click', function() {
          var productId = manualSaleProductIdInput ? manualSaleProductIdInput.value : '';
          if (!productId) return;
          var product = getProductById(productId);
          if (product && product.price) {
            manualSalePriceInput.value = product.price;
            updateManualSaleTotal();
            // Update button states
            useRetailPriceBtn.classList.remove('btn-secondary');
            useRetailPriceBtn.classList.add('btn');
            if (useWholesalePriceBtn) {
              useWholesalePriceBtn.classList.remove('btn');
              useWholesalePriceBtn.classList.add('btn-secondary');
            }
          }
        });
      }
      
      // Wholesale Price button
      if (useWholesalePriceBtn) {
        useWholesalePriceBtn.addEventListener('click', function() {
          var productId = manualSaleProductIdInput ? manualSaleProductIdInput.value : '';
          if (!productId) return;
          var product = getProductById(productId);
          if (product) {
            // Use wholesale price if available, otherwise calculate 70% of retail
            var wholesalePrice = (product.wholesalePrice !== null && product.wholesalePrice !== undefined) 
              ? product.wholesalePrice 
              : (product.price ? Math.round(product.price * 0.7 * 100) / 100 : 0);
            manualSalePriceInput.value = wholesalePrice;
            updateManualSaleTotal();
            // Update button states
            useWholesalePriceBtn.classList.remove('btn-secondary');
            useWholesalePriceBtn.classList.add('btn');
            if (useRetailPriceBtn) {
              useRetailPriceBtn.classList.remove('btn');
              useRetailPriceBtn.classList.add('btn-secondary');
            }
          }
        });
      }
      if (manualSaleAmountPaidInput) {
        manualSaleAmountPaidInput.addEventListener('input', updateChange);
        // Auto-fill with total when modal opens
        manualSaleAmountPaidInput.addEventListener('focus', function() {
          if (!this.value || parseFloat(this.value) === 0) {
            var totalText = manualSaleTotalEl.textContent.replace('‚Ç±', '').replace(/,/g, '');
            var total = parseFloat(totalText) || 0;
            if (total > 0) {
              this.value = total.toFixed(2);
              updateChange();
            }
          }
        });
      }
      if (manualSaleCloseBtn) {
        manualSaleCloseBtn.addEventListener('click', function(e) {
          e.preventDefault();
          closeManualSaleModal();
        });
      }
      if (manualSaleCancelBtn) {
        manualSaleCancelBtn.addEventListener('click', function(e) {
          e.preventDefault();
          closeManualSaleModal();
        });
      }

      function renderSalesEntryGrid() {
        if (!salesEntryGrid) return;
        salesEntryGrid.innerHTML = '';
        
        if (!products || products.length === 0) {
          salesEntryGrid.innerHTML = '<p class="text-muted">No products available.</p>';
          return;
        }
        
        products.forEach(function(product) {
          var card = document.createElement('div');
          card.className = 'product-card';
          var image = resolveProductImage(product.image);
          var stock = getDisplayStock(product);
          
          card.innerHTML = `
            <img src="${image}" alt="${product.name}" onerror="this.onerror=null;this.src='${DEFAULT_PRODUCT_IMAGE}';">
            <div class="product-card-name">${product.name}</div>
            <div class="product-card-meta">${product.brand || ''}</div>
            <div class="product-card-meta">Stock: ${stock}</div>
          `;
          
          card.addEventListener('click', function() {
            openManualSaleModal(product);
          });
          
          salesEntryGrid.appendChild(card);
        });
      }
      
      function loadManualSales() {
        // Always load sales data (needed for notifications even if table doesn't exist)
        var url = API_BASE_URL + '/api/sales/orders';
        console.log('üîÑ [loadManualSales] Starting to load from:', url);
        console.log('üîÑ [loadManualSales] API_BASE_URL:', API_BASE_URL);
        console.log('üîÑ [loadManualSales] Current manualSales length:', manualSales ? manualSales.length : 'undefined');
        
        return fetch(url)
          .then(function(response) {
            console.log('üì° [loadManualSales] Response received:', response.status, response.statusText);
            console.log('üì° [loadManualSales] Response ok?', response.ok);
            if (!response.ok) {
              return response.text().then(function(text) {
                console.error('‚ùå [loadManualSales] Response error text:', text);
                console.error('‚ùå [loadManualSales] Response status:', response.status);
                throw new Error('Failed to load sales orders: ' + response.status + ' - ' + text.substring(0, 200));
              });
            }
            return response.json();
          })
          .then(function(data) {
            console.log('üì¶ [loadManualSales] Raw API response type:', typeof data);
            console.log('üì¶ [loadManualSales] Raw API response is array?', Array.isArray(data));
            console.log('üì¶ [loadManualSales] Raw API response length:', Array.isArray(data) ? data.length : 'N/A');
            console.log('üì¶ [loadManualSales] Raw API response:', data);
            
            manualSales = Array.isArray(data) ? data : [];
            console.log('‚úÖ [loadManualSales] Stored in manualSales:', manualSales.length, 'items');
            console.log('‚úÖ [loadManualSales] manualSales variable:', manualSales);
            
            if (manualSales.length > 0) {
              console.log('üìã [loadManualSales] First sale item:', manualSales[0]);
              console.log('üìã [loadManualSales] First sale items array:', manualSales[0].items);
              if (manualSales[0].items && manualSales[0].items.length > 0) {
                console.log('üìã [loadManualSales] First item in first sale:', manualSales[0].items[0]);
              } else {
                console.warn('‚ö†Ô∏è [loadManualSales] First sale has no items!');
              }
            } else {
              console.warn('‚ö†Ô∏è [loadManualSales] No sales items in response!');
            }
            
            // Only render table if it exists
            if (manualSalesTableBody) {
              renderManualSalesTable();
            }
            refreshSalesSummary();
            updateSalesTodayCount();
            return manualSales;
          })
          .catch(function(error) {
            console.error('‚ùå [loadManualSales] CATCH BLOCK - Error loading sales orders:', error);
            console.error('‚ùå [loadManualSales] Error name:', error.name);
            console.error('‚ùå [loadManualSales] Error message:', error.message);
            console.error('‚ùå [loadManualSales] Error stack:', error.stack);
            if (manualSalesTableBody) {
              manualSalesTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#dc2626; padding: 20px;">Failed to load sales data: ' + error.message + '</td></tr>';
            }
            manualSales = [];
            return [];
          });
      }
      
      function renderManualSalesTable() {
        if (!manualSalesTableBody) return;

        var filtered = getFilteredManualSales();

        if (!filtered || filtered.length === 0) {
          manualSalesTableBody.innerHTML = '<tr><td colspan="5" class="no-data">No sales recorded yet.</td></tr>';
          if (salesTotalAmountEl) {
            salesTotalAmountEl.textContent = '‚Ç±0.00';
          }
          return;
        }
        manualSalesTableBody.innerHTML = '';

        // Get header labels for data-label attributes
        var headerCells = document.querySelectorAll('.manual-sales-table thead th');
        var headerLabels = Array.from(headerCells).map(function(th) {
          return th.textContent.trim();
        });

        // Compute total amount for the currently visible (filtered) sales
        var totalForFiltered = 0;

        filtered.forEach(function(order) {
          var row = document.createElement('tr');
          
          // Get product and category info from items
          var productName = '‚Äî';
          var categoryName = '‚Äî';
          
          // Debug: Log order structure
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            console.warn('‚ö†Ô∏è Order has no items:', {
              order_id: order.id,
              order_number: order.order_number,
              items: order.items,
              full_order: order
            });
          }
          
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            // Get first item for display
            var firstItem = order.items[0];
            productName = firstItem.product_name || firstItem.name || '‚Äî';
            categoryName = firstItem.category_name || firstItem.category || 'Uncategorized';
            
            // If multiple items, show count
            if (order.items.length > 1) {
              productName = productName + ' (+' + (order.items.length - 1) + ' more)';
            }
          } else {
            // Fallback: Items are missing - this shouldn't happen if API is working correctly
            // Log detailed info for debugging
            console.error('‚ùå Order missing items:', {
              order_id: order.id,
              order_number: order.order_number,
              has_items: !!order.items,
              items_type: typeof order.items,
              items_length: order.items ? order.items.length : 'N/A',
              full_order: order
            });
            productName = '‚Äî';
            categoryName = '‚Äî';
          }
          
          var rawTotal = parseFloat(order.total_amount || 0) || 0;
          totalForFiltered += rawTotal;
          var totalFormatted = '‚Ç±' + rawTotal.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          var dateFormatted = order.ordered_at ? new Date(order.ordered_at).toLocaleString() : '‚Äî';
          var statusText = order.payment_status || order.status || 'Paid';
          
          row.innerHTML = `
            <td data-label="${headerLabels[0] || 'Order'}">
              <strong>${order.order_number || ('SO-' + order.id)}</strong>
              <br><small style="color: #6b7280;">${statusText}</small>
            </td>
            <td data-label="${headerLabels[1] || 'Product'}">
              <strong>${productName}</strong>
            </td>
            <td data-label="${headerLabels[2] || 'Category'}">${categoryName}</td>
            <td data-label="${headerLabels[3] || 'Total'}"><strong>${totalFormatted}</strong></td>
            <td data-label="${headerLabels[4] || 'Date / Time'}">${dateFormatted}</td>
          `;
          manualSalesTableBody.appendChild(row);
        });

        if (salesTotalAmountEl) {
          salesTotalAmountEl.textContent = '‚Ç±' + totalForFiltered.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
      }

      function getFilteredManualSales() {
        if (!manualSales || manualSales.length === 0) return [];

        var timeframe = salesTimeframeFilter ? salesTimeframeFilter.value : 'daily';
        var month = salesMonthFilter && salesMonthFilter.value ? parseInt(salesMonthFilter.value, 10) : null;
        var year = salesYearFilter && salesYearFilter.value ? parseInt(salesYearFilter.value, 10) : null;
        var categoryNameFilter = salesCategoryFilter ? salesCategoryFilter.value : '';

        var today = new Date();
        var currentYear = today.getFullYear();
        var currentMonth = today.getMonth() + 1;

        if (!month) month = currentMonth;
        if (!year) year = currentYear;

        return manualSales.filter(function(order) {
          var d = order.ordered_at ? new Date(order.ordered_at) : null;
          if (!d || isNaN(d.getTime())) return false;

          var orderYear = d.getFullYear();
          var orderMonth = d.getMonth() + 1;
          var orderDate = d.getDate();

          // Timeframe filter
          if (timeframe === 'daily') {
            var now = new Date();
            if (orderYear !== now.getFullYear() || orderMonth !== (now.getMonth() + 1) || orderDate !== now.getDate()) {
              return false;
            }
          } else if (timeframe === 'monthly') {
            if (orderYear !== year || orderMonth !== month) {
              return false;
            }
          } else if (timeframe === 'yearly') {
            if (orderYear !== year) {
              return false;
            }
          }

          // Category filter (order matches if any item in that category name)
          if (categoryNameFilter) {
            var hasCategory = (order.items || []).some(function(item) {
              var itemCategory = (item.category_name || 'Uncategorized').toString().trim().toLowerCase();
              var selected = categoryNameFilter.toString().trim().toLowerCase();
              return itemCategory === selected;
            });
            if (!hasCategory) return false;
          }

          return true;
        });
      }

      function refreshSalesSummary() {
        // Just re-render; renderManualSalesTable computes the total for the current filters
        renderManualSalesTable();
      }
      
      // (Dropdown no longer used for sales entry; selection is via product tiles)
      
      // Edit Product Modal functionality
      var editProductModal = document.getElementById('edit-product-modal');
      var closeEditModal = document.getElementById('close-edit-modal');
      var cancelEdit = document.getElementById('cancel-edit');
      var editProductForm = document.getElementById('edit-product-form');
      var editImageInput = document.getElementById('edit-product-image');
      var editImagePreview = document.getElementById('edit-image-preview');
      
      // Open edit product modal
      window.openEditProductModal = function(productId) {
        var product = getProductById(productId);
        if (!product) {
          alert('Product not found');
          return;
        }
        
        // Extract numeric ID
        var numericId = productId.toString().startsWith('p') ? productId.toString().substring(1) : productId;
        
        // Fill form with product data
        document.getElementById('edit-product-id').value = numericId;
        document.getElementById('edit-product-name').value = product.name || '';
        document.getElementById('edit-product-brand').value = product.brand || '';
        document.getElementById('edit-product-size').value = product.size || '';
        document.getElementById('edit-product-condition').value = product.condition || 'New';
        document.getElementById('edit-product-price').value = product.price || 0;
        
        // Populate category dropdown with only the 4 specified categories
        var categorySelect = document.getElementById('edit-product-category');
        if (categorySelect) {
          // Define the allowed categories
          var allowedCategories = [
            'Home & Furniture',
            'Kitchenware & Tableware',
            'Electronics & Appliances',
            'Fashion & Accessories (Ukay-Ukay)',
            'Miscellaneous'
          ];
          
          // Clear and populate dropdown
          categorySelect.innerHTML = '<option value="">Select category</option>';
          allowedCategories.forEach(function(cat) {
            var option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
          });
          
          // Set the selected value to the product's current category (if it's one of the allowed categories)
          if (product.category && allowedCategories.includes(product.category)) {
            categorySelect.value = product.category;
          } else {
            categorySelect.value = '';
          }
        }
        var wholesalePriceInput = document.getElementById('edit-product-wholesale-price');
        if (wholesalePriceInput) {
          // Handle null, undefined, and 0 correctly
          if (product.wholesalePrice !== null && product.wholesalePrice !== undefined) {
            wholesalePriceInput.value = product.wholesalePrice;
          } else {
            wholesalePriceInput.value = '';
          }
          console.log('Setting wholesale price input to:', wholesalePriceInput.value, 'from product.wholesalePrice:', product.wholesalePrice);
        }
        // Stock quantity is not editable in the Edit modal - it can only be changed via the Save button in the table
        var stockInput = document.getElementById('edit-product-stock');
        if (stockInput) {
          // Set to current stock but keep it hidden - we won't send this in the update
          stockInput.value = product.stock || 0;
        }
        // Set low stock threshold
        var lowStockThresholdInput = document.getElementById('edit-product-low-stock-threshold');
        if (lowStockThresholdInput) {
          lowStockThresholdInput.value = product.lowStockThreshold || product.low_stock_threshold || 5;
        }
        // Reset uploaded image path when opening modal
        uploadedEditImagePath = null;
        
        // Show current image (if it exists in database)
        var currentImage = resolveProductImage(product.image);
        if (currentImage && currentImage !== DEFAULT_PRODUCT_IMAGE) {
          editImagePreview.innerHTML = '<img src="' + currentImage + '" alt="Current product image" style="max-width: 200px; max-height: 200px; border-radius: 6px; border: 1px solid #d1d5db;"><p style="font-size: 0.85rem; color: #6b7280; margin-top: 8px;">Current image (upload new file to replace)</p>';
        } else {
          editImagePreview.innerHTML = '<p style="font-size: 0.85rem; color: #6b7280;">No image - please upload an image file</p>';
        }
        
        // Reset submit button state before showing modal
        var submitBtn = editProductForm ? editProductForm.querySelector('button[type="submit"]') : null;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Update Product';
        }
        
      // Show modal
      if (editProductModal) {
        editProductModal.style.display = 'flex';
        
        // Position modal at top, shifted to the left (similar to add product modal)
        setTimeout(function() {
          var modalContent = editProductModal.querySelector('.modal-content');
          
          if (modalContent) {
            var viewportWidth = window.innerWidth;
            var modalWidth = modalContent.offsetWidth || 600;
            
            // Position horizontally shifted to the left (20% from left instead of center)
            var leftPosition = viewportWidth * 0.20;
            var topPosition = 20; // 20px from top
            
            modalContent.style.position = 'fixed';
            modalContent.style.left = leftPosition + 'px';
            modalContent.style.top = topPosition + 'px';
            modalContent.style.right = 'auto';
            modalContent.style.margin = '0';
            
            console.log('Edit modal positioned at top, shifted left');
          }
        }, 50);
      }
      };
      
      // Close edit modal
      function closeEditProductModal() {
        if (editProductModal) {
          editProductModal.style.display = 'none';
        }
        if (editProductForm) {
          editProductForm.reset();
        }
        if (editImagePreview) {
          editImagePreview.innerHTML = '';
        }
        if (editImageInput) {
          editImageInput.value = '';
        }
        uploadedEditImagePath = null; // Reset uploaded image path
        
        // Reset submit button state
        var submitBtn = editProductForm ? editProductForm.querySelector('button[type="submit"]') : null;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Update Product';
        }
      }
      
      // Close edit modal handlers
      if (closeEditModal) {
        closeEditModal.addEventListener('click', function(e) {
          e.preventDefault();
          closeEditProductModal();
        });
      }
      
      if (cancelEdit) {
        cancelEdit.addEventListener('click', function(e) {
          e.preventDefault();
          closeEditProductModal();
        });
      }
      
      // Close edit modal when clicking outside
      if (editProductModal) {
        editProductModal.addEventListener('click', function(event) {
          if (event.target === editProductModal) {
            closeEditProductModal();
          }
        });
        
        var editModalContent = editProductModal.querySelector('.modal-content');
        if (editModalContent) {
          editModalContent.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }
      }
      
      // Edit image upload buttons
      var editChooseFileBtn = document.getElementById('edit-choose-file-btn');
      var editCameraBtn = document.getElementById('edit-camera-btn');

      if (editChooseFileBtn && editImageInput) {
        editChooseFileBtn.addEventListener('click', function() {
          // Remove capture attribute for file selection
          editImageInput.removeAttribute('capture');
          editImageInput.click();
        });
      }

      if (editCameraBtn && editImageInput) {
        editCameraBtn.addEventListener('click', function() {
          // Add capture attribute to use camera
          editImageInput.setAttribute('capture', 'environment');
          editImageInput.click();
        });
      }
      
      // Edit image preview and base64 conversion
      if (editImageInput) {
        editImageInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
              alert('Please select a valid image file (JPG, PNG, etc.)');
              editImageInput.value = '';
              return;
            }
            
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
              alert('Image file is too large. Maximum size is 5MB.');
              editImageInput.value = '';
              return;
            }
            
            // Convert to base64
            var reader = new FileReader();
            reader.onload = function(e) {
              var base64String = e.target.result; // This is already in data:image/...;base64,... format
              uploadedEditImagePath = base64String; // Store base64 string
              editImagePreview.innerHTML = '<img src="' + base64String + '" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 6px; border: 1px solid #d1d5db;"><p style="font-size: 0.85rem; color: #059669; margin-top: 8px;">‚úì Image ready</p>';
            };
            reader.onerror = function() {
              alert('Error reading image file');
              editImageInput.value = '';
              editImagePreview.innerHTML = '';
              uploadedEditImagePath = null;
            };
            reader.readAsDataURL(file);
          }
        });
      }
      
      // Edit product form submission
      if (editProductForm) {
        editProductForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Check permissions
          var canEdit = !!(permissions.inventory && permissions.inventory.edit);
          if (permissions.inventory && permissions.inventory.edit === false) {
            alert('You do not have permission to edit products.');
            return;
          }
          
          var productId = document.getElementById('edit-product-id').value;
          if (!productId) {
            alert('Product ID not found');
            return;
          }
          
          // Disable submit button
          var submitBtn = editProductForm.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
          }
          
          // Use uploaded image path if available, otherwise keep existing image
          var imagePathToUse = uploadedEditImagePath || null;
          console.log('Image to use for update:', imagePathToUse ? 'Base64 image provided' : 'No new image');
          updateProductWithImage(imagePathToUse);
          
          function updateProductWithImage(imagePath) {
            // Get form values
            var wholesalePriceInput = document.getElementById('edit-product-wholesale-price');
            // Allow clearing wholesale price - empty string or null means no wholesale price
            var wholesalePriceValue = wholesalePriceInput ? wholesalePriceInput.value.trim() : '';
            console.log('Raw wholesale price input value:', wholesalePriceValue);
            var wholesalePrice = null;
            if (wholesalePriceValue && wholesalePriceValue !== '') {
              wholesalePrice = parseFloat(wholesalePriceValue);
              if (isNaN(wholesalePrice)) {
                console.warn('Invalid wholesale price value, setting to null');
                wholesalePrice = null;
              } else {
                console.log('Parsed wholesale price:', wholesalePrice);
              }
            } else {
              console.log('Wholesale price is empty, setting to null');
            }
            
            // Stock quantity is NOT updated via Edit modal - it can only be changed via the Save button in the inventory table
            // We explicitly exclude stock from the update to prevent accidental changes
            
            var lowStockThresholdInput = document.getElementById('edit-product-low-stock-threshold');
            var lowStockThresholdValue = lowStockThresholdInput ? lowStockThresholdInput.value.trim() : '';
            var lowStockThreshold = lowStockThresholdValue !== '' ? parseInt(lowStockThresholdValue) : 5;
            if (isNaN(lowStockThreshold) || lowStockThreshold < 0) {
              lowStockThreshold = 5; // Default to 5 if invalid
            }
            console.log('Low stock threshold from input:', lowStockThresholdValue, 'parsed:', lowStockThreshold);
            
            var productData = {
              name: document.getElementById('edit-product-name').value.trim(),
              brand: document.getElementById('edit-product-brand').value.trim(),
              category: document.getElementById('edit-product-category').value.trim(),
              size: document.getElementById('edit-product-size').value,
              condition: document.getElementById('edit-product-condition').value,
              price: parseFloat(document.getElementById('edit-product-price').value),
              wholesalePrice: wholesalePrice,
              lowStockThreshold: lowStockThreshold,
              // stock: stock, // REMOVED - Stock can only be updated via Save button in table
              image: imagePath
            };
            
            // Validation
            if (!productData.name) {
              alert('Product name is required');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Product';
              }
              return;
            }
            
            if (isNaN(productData.price) || productData.price <= 0) {
              alert('Please enter a valid price');
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Product';
              }
              return;
            }
            
            // Stock validation removed - stock can only be changed via Save button in table
            
            // Disable submit button
            var submitBtn = editProductForm.querySelector('button[type="submit"]');
            if (submitBtn) {
              submitBtn.disabled = true;
              submitBtn.textContent = 'Updating...';
            }
            
            // First get category_id
            fetch(API_BASE_URL + '/api/categories')
              .then(function(response) {
                if (!response.ok) {
                  throw new Error('Failed to fetch categories');
                }
                return response.json();
              })
              .then(function(categories) {
                var foundCategory = categories.find(function(cat) {
                  return cat.name === productData.category;
                });
                var categoryId = foundCategory ? foundCategory.id : null;
                
                // If category doesn't exist, create it
                if (!categoryId && productData.category) {
                  return fetch(API_BASE_URL + '/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: productData.category })
                  })
                  .then(function(response) {
                    if (!response.ok) {
                      return response.json().then(function(err) {
                        throw new Error(err.error || 'Failed to create category');
                      });
                    }
                    return response.json();
                  })
                  .then(function(newCategory) { return newCategory.id; });
                }
                return categoryId;
              })
              .then(function(categoryId) {
                // Prepare update data - always include wholesale_price
                var updateData = {
                  name: productData.name,
                  brand: productData.brand || null,
                  category_id: categoryId,
                  size: productData.size || null,
                  condition_grade: productData.condition,
                  retail_price: productData.price,
                  wholesale_price: null, // Will be set below
                  low_stock_threshold: productData.lowStockThreshold
                };
                
                // Set wholesale price - allow null to clear it, or any valid number (including 0)
                if (productData.wholesalePrice !== null && productData.wholesalePrice !== undefined && !isNaN(productData.wholesalePrice) && productData.wholesalePrice >= 0) {
                  updateData.wholesale_price = productData.wholesalePrice;
                  console.log('Setting wholesale_price to:', productData.wholesalePrice);
                } else if (productData.wholesalePrice === 0) {
                  // Explicitly handle 0 as a valid value
                  updateData.wholesale_price = 0;
                  console.log('Setting wholesale_price to 0');
                } else {
                  // Explicitly set to null to clear wholesale price
                  updateData.wholesale_price = null;
                  console.log('Clearing wholesale_price (setting to null)');
                }
                
                // Stock quantity is NOT included in Edit modal updates
                // Stock can only be changed via the Save button in the inventory table
                // This ensures the Save button has a clear purpose for stock management
                
                // Include image path if a new image was uploaded
                if (imagePath && imagePath.trim()) {
                  updateData.image = imagePath;
                  console.log('Including image in update:', imagePath.substring(0, 50) + '...');
                } else {
                  console.log('No new image provided, keeping existing image');
                }
                
                console.log('Update data:', JSON.stringify(updateData, null, 2));
                
                // Update product via API (including image if provided)
                return fetch(API_BASE_URL + '/api/products/' + productId, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updateData)
                });
              })
              .then(function(response) {
                var contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                  return response.text().then(function(text) {
                    console.error('Non-JSON response when updating product:', text.slice(0, 200));
                    throw new Error('Server returned HTML instead of JSON. Make sure the server is running.');
                  });
                }
                if (!response.ok) {
                  return response.json().then(function(data) {
                    throw new Error(data.error || 'Failed to update product');
                  });
                }
                return response.json();
              })
              .then(function(result) {
                console.log('Product update successful:', result);
                
                // Update local product
                var localProduct = products.find(function(p) {
                  return p.id === 'p' + productId || p.id === productId;
                });
                if (localProduct) {
                  localProduct.name = productData.name;
                  localProduct.brand = productData.brand;
                  localProduct.category = productData.category;
                  localProduct.size = productData.size;
                  localProduct.condition = productData.condition;
                  localProduct.price = productData.price;
                  localProduct.wholesalePrice = productData.wholesalePrice;
                  if (productData.stock !== null && productData.stock !== undefined) {
                    localProduct.stock = productData.stock;
                    localProduct.availability = productData.stock > 0 ? 'In Stock' : 'Out of Stock';
                  }
                  // Update image if a new one was uploaded
                  // If we have a base64 image, keep it temporarily until refresh loads the file path
                  if (imagePath) {
                    if (imagePath.startsWith('data:image/')) {
                      // Keep base64 for immediate display until server refresh
                      localProduct.image = imagePath;
                      console.log('Updated local product with base64 image (temporary)');
                    } else {
                      // File path from server
                      localProduct.image = resolveProductImage(imagePath);
                      console.log('Updated local product with file path:', imagePath);
                    }
                  }
                }

                // Try to keep products cache in sync, but ignore quota errors
                try {
                  localStorage.setItem('products', JSON.stringify(products));
                } catch (storageError) {
                  console.warn('‚ö†Ô∏è Unable to update products cache in localStorage (quota exceeded).', storageError);
                }
                
                // Refresh inventory from server to get updated data including new image path
                loadProductsFromServer()
                  .then(function() {
                    console.log('Products refreshed from server after update');
                    populateBrandAndCategoryComboboxes(); // Update comboboxes after product update
                    populateCategoryFilter(); // Update category filter combobox
                    alert('Product updated successfully!');
                    closeEditProductModal();
                  })
                  .catch(function(err) {
                    console.error('Error refreshing products:', err);
                    // Still show success even if refresh fails
                    alert('Product updated successfully! (Note: Please refresh the page to see the updated image)');
                    closeEditProductModal();
                  });
              })
              .catch(function(error) {
                console.error('Error updating product:', error);
                console.error('Error details:', error);
                var errorMessage = error.message || 'Unknown error occurred';
                alert('Error updating product: ' + errorMessage + '\n\nPlease check the console for more details.');
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'Update Product';
                }
              });
          }
        });
      }

      // Function to reset form
      function resetAddProductForm() {
        if (addProductForm) {
          addProductForm.reset();
        }
        if (imagePreview) {
          imagePreview.innerHTML = '';
        }
        if (imageInput) {
          imageInput.value = '';
        }
        uploadedImagePath = null; // Reset uploaded image path
      }

      // Function to close modal
      function closeAddProductModal() {
        if (addProductModal) {
          addProductModal.style.display = 'none';
          // Reset modal position
          var modalContent = addProductModal.querySelector('.modal-content');
          if (modalContent) {
            modalContent.style.position = '';
            modalContent.style.left = '';
            modalContent.style.top = '';
            modalContent.style.right = '';
          }
        }
        resetAddProductForm();
      }

      // Open modal
      if (addProductBtn) {
        addProductBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Add product button clicked');
          if (addProductModal) {
            addProductModal.style.display = 'flex';
            console.log('Modal should be visible now');
            
            // Position modal responsively
            setTimeout(function() {
              var modalContent = addProductModal.querySelector('.modal-content');
              
              if (modalContent) {
                var viewportWidth = window.innerWidth;
                var isMobile = viewportWidth <= 768;
                var isSmallMobile = viewportWidth <= 480;
                
                if (isSmallMobile) {
                  // Full screen on small mobile
                  modalContent.style.position = 'fixed';
                  modalContent.style.left = '0';
                  modalContent.style.top = '0';
                  modalContent.style.right = '0';
                  modalContent.style.bottom = '0';
                  modalContent.style.width = '100%';
                  modalContent.style.maxWidth = '100%';
                  modalContent.style.height = '100vh';
                  modalContent.style.maxHeight = '100vh';
                  modalContent.style.margin = '0';
                  modalContent.style.borderRadius = '0';
                } else if (isMobile) {
                  // Centered on tablet
                  modalContent.style.position = 'fixed';
                  modalContent.style.left = '50%';
                  modalContent.style.top = '50%';
                  modalContent.style.transform = 'translate(-50%, -50%)';
                  modalContent.style.right = 'auto';
                  modalContent.style.width = '90%';
                  modalContent.style.maxWidth = '600px';
                  modalContent.style.maxHeight = '90vh';
                  modalContent.style.margin = '0';
                } else {
                  // Desktop: Position at top, shifted to the left
                  var leftPosition = viewportWidth * 0.20;
                  var topPosition = 20;
                  
                  modalContent.style.position = 'fixed';
                  modalContent.style.left = leftPosition + 'px';
                  modalContent.style.top = topPosition + 'px';
                  modalContent.style.right = 'auto';
                  modalContent.style.transform = 'none';
                  modalContent.style.width = 'auto';
                  modalContent.style.maxWidth = '600px';
                  modalContent.style.maxHeight = 'calc(100vh - 40px)';
                  modalContent.style.margin = '0';
                }
                
                console.log('Modal positioned responsively');
              }
            }, 50);
          } else {
            console.error('Modal element not found');
          }
        });
      } else {
        console.error('Add product button not found');
      }

      // Function to position Add Product modal responsively (reusable)
      function positionAddProductModal() {
        if (!addProductModal || addProductModal.style.display === 'none') return;
        
        var modalContent = addProductModal.querySelector('.modal-content');
        if (!modalContent) return;
        
        var viewportWidth = window.innerWidth;
        var isMobile = viewportWidth <= 768;
        var isSmallMobile = viewportWidth <= 480;
        
        if (isSmallMobile) {
          // Full screen on small mobile
          modalContent.style.position = 'fixed';
          modalContent.style.left = '0';
          modalContent.style.top = '0';
          modalContent.style.right = '0';
          modalContent.style.bottom = '0';
          modalContent.style.width = '100%';
          modalContent.style.maxWidth = '100%';
          modalContent.style.height = '100vh';
          modalContent.style.maxHeight = '100vh';
          modalContent.style.margin = '0';
          modalContent.style.borderRadius = '0';
        } else if (isMobile) {
          // Centered on tablet
          modalContent.style.position = 'fixed';
          modalContent.style.left = '50%';
          modalContent.style.top = '50%';
          modalContent.style.transform = 'translate(-50%, -50%)';
          modalContent.style.right = 'auto';
          modalContent.style.width = '90%';
          modalContent.style.maxWidth = '600px';
          modalContent.style.maxHeight = '90vh';
          modalContent.style.margin = '0';
          modalContent.style.borderRadius = '12px';
        } else {
          // Desktop: Position at top, shifted to the left
          var leftPosition = Math.max(20, viewportWidth * 0.20);
          var topPosition = 20;
          
          modalContent.style.position = 'fixed';
          modalContent.style.left = leftPosition + 'px';
          modalContent.style.top = topPosition + 'px';
          modalContent.style.right = 'auto';
          modalContent.style.transform = 'none';
          modalContent.style.width = 'auto';
          modalContent.style.maxWidth = '600px';
          modalContent.style.maxHeight = 'calc(100vh - 40px)';
          modalContent.style.margin = '0';
          modalContent.style.borderRadius = '12px';
        }
      }

      // Reposition modal on window resize
      var addProductModalResizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(addProductModalResizeTimeout);
        addProductModalResizeTimeout = setTimeout(function() {
          if (addProductModal && addProductModal.style.display === 'flex') {
            positionAddProductModal();
          }
        }, 150);
      });

      // Close modal with X button
      if (closeModal) {
        closeModal.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeAddProductModal();
        });
      }

      // Close modal with Cancel button
      if (cancelAdd) {
        cancelAdd.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeAddProductModal();
        });
      }

      // Prevent closing on outside click and position on right side
      if (addProductModal) {
        var modalContent = addProductModal.querySelector('.modal-content');
        
        // Prevent modal from closing when clicking outside
        addProductModal.addEventListener('click', function(event) {
          // Don't close when clicking outside - user requested this
          event.stopPropagation();
        });
        
        // Prevent modal from closing when clicking inside modal-content
        if (modalContent) {
          modalContent.addEventListener('click', function(event) {
            event.stopPropagation();
          });
        }
      }

      // Add Product image upload buttons
      if (chooseFileBtn && imageInput) {
        chooseFileBtn.addEventListener('click', function() {
          // Remove capture attribute for file selection
          imageInput.removeAttribute('capture');
          imageInput.click();
        });
      }

      if (cameraBtn && imageInput) {
        cameraBtn.addEventListener('click', function() {
          // Add capture attribute to use camera
          imageInput.setAttribute('capture', 'environment');
          imageInput.click();
        });
      }

      // Image preview and base64 conversion
      if (imageInput) {
        imageInput.addEventListener('change', function(e) {
          var file = e.target.files[0];
          if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
              alert('Please select a valid image file (JPG, PNG, etc.)');
              imageInput.value = '';
              return;
            }
            
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
              alert('Image file is too large. Maximum size is 5MB.');
              imageInput.value = '';
              return;
            }
            
            // Convert to base64
            var reader = new FileReader();
            reader.onload = function(e) {
              var base64String = e.target.result; // This is already in data:image/...;base64,... format
              uploadedImagePath = base64String; // Store base64 string
              imagePreview.innerHTML = '<img src="' + base64String + '" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 6px; border: 1px solid #d1d5db;"><p style="font-size: 0.85rem; color: #059669; margin-top: 8px;">‚úì Image ready</p>';
            };
            reader.onerror = function() {
              alert('Error reading image file');
              imageInput.value = '';
              imagePreview.innerHTML = '';
              uploadedImagePath = null;
            };
            reader.readAsDataURL(file);
          }
        });
      }

      // Add product form submission
      if (addProductForm) {
        addProductForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          console.log('Form submitted');
          
          // Check permissions
          var canEdit = !!(permissions.inventory && permissions.inventory.edit);
          if (permissions.inventory && permissions.inventory.edit === false) {
            alert('You do not have permission to add products.');
            return;
          }
          
          // Check if image was already uploaded
          if (!uploadedImagePath) {
            alert('Please wait for the image to finish uploading, or select an image file.');
            return;
          }
          
          // Disable submit button to prevent double submission
          var submitBtn = addProductForm.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding Product...';
          }
          
          // Get form values
          var wholesalePriceInput = document.getElementById('product-wholesale-price');
          var wholesalePrice = wholesalePriceInput && wholesalePriceInput.value ? parseFloat(wholesalePriceInput.value) : null;
          
          var productData = {
            name: document.getElementById('product-name').value,
            brand: document.getElementById('product-brand').value,
            category: document.getElementById('product-category').value,
            size: document.getElementById('product-size').value,
            condition: document.getElementById('product-condition').value,
            price: parseFloat(document.getElementById('product-price').value),
            originalPrice: null, // Original price removed from add product form
            wholesalePrice: wholesalePrice,
            stock: parseInt(document.getElementById('product-stock').value),
            image: uploadedImagePath // Use the already uploaded file path
          };
          
          // Save to database via API
          fetch(API_BASE_URL + '/api/products', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
          })
            .then(function(response) {
              // Some server errors (or wrong URL) return HTML instead of JSON.
              // Guard against that so we don't get "Unexpected token <" errors.
              var contentType = response.headers.get('content-type') || '';
              if (!contentType.includes('application/json')) {
                return response.text().then(function(text) {
                  console.error('Non-JSON response when adding product:', text.slice(0, 200));
                  var message = 'Server returned HTML instead of JSON. ' +
                    'Make sure the backend server is running and accessible at ' + API_BASE_URL + ' and that /api/products exists.';
                  throw new Error(message);
                });
              }

              return response.json().then(function(data) {
                if (!response.ok) {
                  throw new Error(data.error || 'Failed to add product');
                }
                return data;
              });
            })
            .then(function(result) {
              console.log('Product added to database:', result);
              
              // Also add to local products array for immediate display
              var resolvedImage = resolveProductImage(productData.image);
              var newProduct = {
                id: 'p' + result.id,
                name: productData.name,
                brand: productData.brand,
                category: productData.category,
                size: productData.size,
                condition: productData.condition,
                price: productData.price,
                originalPrice: productData.originalPrice,
                wholesalePrice: productData.wholesalePrice,
                stock: productData.stock,
                availability: 'In Stock',
                image: resolvedImage
              };

              products.push(newProduct);
              // Try to store in localStorage, but don't fail if quota is exceeded
              try {
                localStorage.setItem('products', JSON.stringify(products));
              } catch (storageError) {
                console.warn('‚ö†Ô∏è Unable to save new product list to localStorage (quota exceeded).', storageError);
              }
              
              // Close modal and reset form
              addProductModal.style.display = 'none';
              addProductForm.reset();
              imagePreview.innerHTML = '';
              uploadedImagePath = null; // Reset uploaded image path
              
              // Refresh products and update comboboxes
              loadProductsFromServer().then(function() {
                populateBrandAndCategoryComboboxes(); // Update comboboxes after adding product
                populateCategoryFilter(); // Update category filter combobox with new categories
                // Also refresh product history so the new product appears there
                renderProductHistory(true);
                populateHistoryCategoryFilter();
              });
              
              // Update inventory display if on inventory page
              if (document.getElementById('inventory') && document.getElementById('inventory').classList.contains('active')) {
                renderInventory();
              }
            })
            .catch(function(error) {
              console.error('Error adding product:', error);
              alert('Error adding product: ' + error.message);
            })
            .finally(function() {
              // Re-enable submit button
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Product';
              }
            });
        });
      }

      // Manual sale form submission
      if (manualSaleForm) {
        manualSaleForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();

          // Get product ID from the hidden input field (populated when product is clicked)
          var productId = manualSaleProductIdInput ? manualSaleProductIdInput.value : '';
          var quantity = manualSaleQuantityInput ? parseInt(manualSaleQuantityInput.value, 10) : 1;
          var price = manualSalePriceInput ? parseFloat(manualSalePriceInput.value) : 0;
          var totalText = manualSaleTotalEl.textContent.replace('‚Ç±', '').replace(/,/g, '');
          var total = parseFloat(totalText) || 0;
          var amountPaid = manualSaleAmountPaidInput ? parseFloat(manualSaleAmountPaidInput.value || '0') : 0;
          var change = amountPaid - total;

          if (!productId) {
            alert('Please select a product to sell.');
            return;
          }

          if (!quantity || quantity <= 0) {
            alert('Quantity must be greater than zero.');
            return;
          }

          if (!price || price <= 0) {
            alert('Please enter a valid price.');
            return;
          }

          if (!amountPaid || amountPaid <= 0) {
            alert('Please enter the amount paid by the customer.');
            return;
          }

          if (amountPaid < total) {
            alert('Amount paid (‚Ç±' + amountPaid.toFixed(2) + ') is less than total (‚Ç±' + total.toFixed(2) + '). Please collect the full amount.');
            return;
          }

          var submitBtn = manualSaleForm.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Recording...';
          }

          // Get current user ID for created_by field
          var userId = currentUser && currentUser.id ? currentUser.id : null;
          // Extract numeric ID if product ID has 'p' prefix
          var numericUserId = userId && userId.toString().startsWith('p') 
            ? userId.toString().substring(1) 
            : userId;

          fetch(API_BASE_URL + '/api/sales/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              customer: {
                name: 'Walk-in Customer'
              },
              product_id: productId,
              quantity: quantity,
              unit_price: price,
              total_amount: total,
              amount_paid: amountPaid,
              change_amount: change,
              created_by: numericUserId
            })
          })
          .then(function(response) {
            var contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
              return response.text().then(function(text) {
                console.error('Non-JSON response when recording sale:', text.slice(0, 200));
                throw new Error('Server returned HTML instead of JSON. Make sure the server is running.');
              });
            }
            if (!response.ok) {
              return response.json().then(function(data) {
                throw new Error(data.error || 'Failed to record sale');
              });
            }
            return response.json();
          })
          .then(function(result) {
            console.log('Sale recorded successfully:', result);
            
            // Show sales notification in Inventory section
            showSalesNotification(result);
            
            alert('Sale recorded successfully!');
            closeManualSaleModal();
            loadManualSales().then(function() {
              updateNotificationBadge();
              // Refresh notification content if sold tab is active
              if (notificationDropdown && notificationDropdown.style.display !== 'none' && activeNotificationTab === 'sold') {
                renderNotificationContent('sold');
              }
            });
            loadProductsFromServer();
            renderSalesEntryGrid(); // Refresh the product grid
          })
          .catch(function(error) {
            console.error('Error recording sale:', error);
            alert('Failed to record sale: ' + error.message);
          })
          .finally(function() {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'Confirm Sale';
            }
          });
        });
      }

      // Update inventory display
      function updateInventoryDisplay() {
        // Reload products from localStorage to get latest data
        var savedProducts = localStorage.getItem('products');
        if (savedProducts) {
          products = JSON.parse(savedProducts);
        }
        
        // Update product count
        var totalProductsEl = document.getElementById('total-products-count');
        if (totalProductsEl) {
          totalProductsEl.textContent = products.length;
        }
        
        // Calculate inventory value
        var inventoryValue = products.reduce(function(sum, p) {
          return sum + (p.price * (getDisplayStock(p) || 0));
        }, 0);
        var inventoryValueEl = document.getElementById('inventory-value');
        if (inventoryValueEl) {
          inventoryValueEl.textContent = '‚Ç±' + inventoryValue.toFixed(2);
        }
        
        // Update low stock count
        var lowStockItems = products.filter(function(p) {
          var currentStock = getDisplayStock(p) || 0;
          return currentStock <= 5;
        });
        var lowStockCountEl = document.getElementById('low-stock-items-count');
        if (lowStockCountEl) {
          lowStockCountEl.textContent = lowStockItems.length;
        }
        
        // Refresh the inventory table if it exists
        var inventoryTable = document.querySelector('#inventory-table tbody');
        if (inventoryTable) {
          renderInventoryTable();
        }
        
        console.log('Inventory updated with new product');
      }

      // Render inventory table
      function renderInventoryTable() {
        var tbody = document.querySelector('#inventory-table tbody');
        if (!tbody) return;
        
        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280; padding: 20px;">No products found. Add your first product!</td></tr>';
          return;
        }
        
        tbody.innerHTML = products.map(function(product) {
          var displayStock = getDisplayStock(product);
          return `
            <tr>
              <td>${product.id || 'N/A'}</td>
              <td>${product.name || 'N/A'}</td>
              <td>${product.brand || 'N/A'}</td>
              <td>${product.category || 'N/A'}</td>
              <td>${displayStock || 0}</td>
              <td>‚Ç±${product.price ? product.price.toFixed(2) : '0.00'}</td>
              <td>${product.availability || 'In Stock'}</td>
              <td>
                <button class="btn-small btn-secondary" onclick="openEditProductModal('${product.id}')">Edit</button>
                <button class="btn-small btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
              </td>
            </tr>
          `;
        }).join('');
      }

      // Track last movement ID for auto-refresh
      var lastMovementId = 0;
      
      // Render product history
      function renderProductHistory(forceRefresh) {
        var tbody = document.getElementById('product-history-table-body');
        var categoryFilter = document.getElementById('history-category-filter');
        if (!tbody) return;
        
        // Only show loading if it's a forced refresh or first load
        if (forceRefresh || tbody.innerHTML.includes('Loading') || tbody.innerHTML.includes('No history')) {
          tbody.innerHTML = '<tr><td colspan="7" class="no-data">Loading history...</td></tr>';
        }
        
        var categoryName = categoryFilter ? categoryFilter.value : '';
        var url = API_BASE_URL + '/api/inventory/movements';
        
        fetch(url)
          .then(function(response) {
            return response.json();
          })
          .then(function(movements) {
            // First, update the filter dropdown with categories from movements (in case products don't have all categories)
            var allCategories = new Set();
            movements.forEach(function(movement) {
              var movementCategory = movement.category_name;
              if (!movementCategory && movement.product_id) {
                var product = products.find(function(p) {
                  var numericId = p.id.toString().startsWith('p') ? p.id.toString().substring(1) : p.id;
                  return numericId == movement.product_id;
                });
                movementCategory = product ? (product.category || product.category_name) : null;
              }
              if (movementCategory && String(movementCategory).trim() && String(movementCategory).trim() !== 'Uncategorized') {
                allCategories.add(String(movementCategory).trim());
              }
            });
            
            // Also add categories from products array
            products.forEach(function(product) {
              var category = product.category || product.category_name || product.categoryName;
              if (category && String(category).trim() && String(category).trim() !== 'Uncategorized') {
                allCategories.add(String(category).trim());
              }
            });
            
            // Update filter dropdown if needed
            if (categoryFilter && allCategories.size > 0) {
              var currentValue = categoryFilter.value;
              var existingOptions = Array.from(categoryFilter.options).map(function(opt) { return opt.value; });
              var needsUpdate = false;
              
              allCategories.forEach(function(cat) {
                if (!existingOptions.includes(cat)) {
                  needsUpdate = true;
                }
              });
              
              if (needsUpdate) {
                var allCategoriesArray = Array.from(allCategories).sort();
                categoryFilter.innerHTML = '<option value="">All Categories</option>';
                allCategoriesArray.forEach(function(category) {
                  var option = document.createElement('option');
                  option.value = category;
                  option.textContent = category;
                  categoryFilter.appendChild(option);
                });
                if (currentValue && allCategoriesArray.includes(currentValue)) {
                  categoryFilter.value = currentValue;
                }
              }
            }
            
            // Filter by category name on client side
            console.log('üîç Filtering movements by category:', categoryName || '(All Categories)');
            console.log('üìä Total movements before filter:', movements.length);
            
            // Only filter if a category is selected (not "All Categories")
            if (categoryName && categoryName.trim() !== '') {
              var originalCount = movements.length;
              movements = movements.filter(function(movement) {
                // Use category_name from API response, or fallback to looking up from products
                var movementCategory = movement.category_name;
                if (!movementCategory && movement.product_id) {
                  var product = products.find(function(p) {
                    var numericId = p.id.toString().startsWith('p') ? p.id.toString().substring(1) : p.id;
                    return numericId == movement.product_id;
                  });
                  movementCategory = product ? (product.category || product.category_name) : null;
                }
                // Normalize both values for comparison (trim and compare)
                var normalizedMovementCategory = movementCategory ? String(movementCategory).trim() : '';
                var normalizedCategoryName = categoryName ? String(categoryName).trim() : '';
                var matches = normalizedMovementCategory === normalizedCategoryName;
                if (!matches && movementCategory) {
                  console.log('‚ùå Category mismatch:', normalizedMovementCategory, '!==', normalizedCategoryName);
                }
                return matches;
              });
              console.log('‚úÖ Movements after filter:', movements.length, 'out of', originalCount);
            } else {
              console.log('‚úÖ Showing all movements (All Categories selected)');
            }
            if (movements.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="no-data">No history found.</td></tr>';
              lastMovementId = 0;
              return;
            }
            
            // Get header labels for data-label attributes
            var headerCells = document.querySelectorAll('#product-history-table thead th');
            var headerLabels = Array.from(headerCells).map(function(th) {
              return th.textContent.trim();
            });
            
            // Check if there are new movements
            var latestMovementId = movements.length > 0 ? movements[0].id : 0;
            var hasNewMovements = lastMovementId > 0 && latestMovementId > lastMovementId;
            
            // Always update on forced refresh or first load
            if (forceRefresh || lastMovementId === 0 || hasNewMovements) {
              // Update last movement ID
              if (latestMovementId > 0) {
                lastMovementId = latestMovementId;
              }
              
              // Use document fragment for better performance
              var fragment = document.createDocumentFragment();
              
              movements.forEach(function(movement) {
                var row = document.createElement('tr');
                var changeQty = movement.change_qty;
                var changeClass = changeQty > 0 ? 'positive' : changeQty < 0 ? 'negative' : 'neutral';
                var changeText = changeQty > 0 ? '+' + changeQty : changeQty.toString();
                var date = new Date(movement.created_at);
                var formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                // Highlight new movements (created in last 5 seconds)
                var movementTime = new Date(movement.created_at).getTime();
                var fiveSecondsAgo = Date.now() - 5000;
                var isNew = movementTime > fiveSecondsAgo ? 'history-new' : '';
                
                // Get category from movement or lookup from products
                var category = movement.category_name || '‚Äî';
                if (!category && movement.product_id) {
                  var product = products.find(function(p) {
                    var numericId = p.id.toString().startsWith('p') ? p.id.toString().substring(1) : p.id;
                    return numericId == movement.product_id;
                  });
                  category = product ? (product.category || product.category_name || '‚Äî') : '‚Äî';
                }
                
                row.className = isNew;
                row.innerHTML = `
                  <td data-label="${headerLabels[0] || 'Date/Time'}" class="history-date">${formattedDate}</td>
                  <td data-label="${headerLabels[1] || 'Product'}" class="history-product">${movement.product_name || 'Unknown Product'}</td>
                  <td data-label="${headerLabels[2] || 'Category'}" class="history-category">${category}</td>
                  <td data-label="${headerLabels[3] || 'Reason'}" class="history-reason">${movement.reason || '‚Äî'}</td>
                  <td data-label="${headerLabels[4] || 'Quantity Change'}" class="history-quantity text-center">
                    <span class="quantity-change ${changeClass}">${changeText}</span>
                    </td>
                  <td data-label="${headerLabels[5] || 'Reference'}" class="history-reference">${movement.reference_type ? movement.reference_type + ' #' + (movement.reference_id || 'N/A') : '‚Äî'}</td>
                  <td data-label="${headerLabels[6] || 'User'}" class="history-user">${movement.created_by_name || '‚Äî'}</td>
                `;
                fragment.appendChild(row);
              });
              
              tbody.innerHTML = '';
              tbody.appendChild(fragment);
              
              // Auto-scroll disabled to prevent unwanted page movement
              // Users can manually scroll if needed
            }
          })
          .catch(function(error) {
            console.error('Error loading product history:', error);
            if (forceRefresh) {
              tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #dc2626;">Error loading history. Please try again.</td></tr>';
            }
          });
      }
      
      // Check for new inventory movements
      function checkForNewMovements() {
        var productHistorySection = document.getElementById('product-history');
        
        // Only check if product history section is active
        if (productHistorySection && productHistorySection.classList.contains('active')) {
          renderProductHistory(false); // Don't force refresh, just check for new ones
        }
      }
      
      // Populate product history category filter dropdown - based on categories from created products
      function populateHistoryCategoryFilter() {
        var filter = document.getElementById('history-category-filter');
        if (!filter) {
          console.warn('‚ö†Ô∏è History category filter element not found');
          return;
        }
        
        console.log('üîç populateHistoryCategoryFilter() called, products array length:', products.length);
        
        // Extract unique categories from products (from created products) - same logic as inventory filter
        var categories = new Set();
        products.forEach(function(product) {
          // Check multiple possible category field names
          var category = product.category || product.category_name || product.categoryName;
          if (category && String(category).trim() && String(category).trim() !== 'Uncategorized') {
            categories.add(String(category).trim());
          }
        });
        
        console.log('üìã Extracted categories for history filter:', Array.from(categories));
        
        // Save current selection
        var currentValue = filter.value;
        
        // Clear and rebuild options
        filter.innerHTML = '<option value="">All Categories</option>';
        
        // Add categories from products, sorted alphabetically
        Array.from(categories).sort().forEach(function(category) {
          var option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          filter.appendChild(option);
        });
        
        // Restore selection if it still exists
        if (currentValue && Array.from(categories).includes(currentValue)) {
          filter.value = currentValue;
        }
        
        console.log('‚úÖ History category filter dropdown updated with', categories.size, 'categories from products');
        
        if (categories.size === 0) {
          console.warn('‚ö†Ô∏è No categories found in products array for history filter');
        }
      }
      
      // Event listeners for product history
      var historyCategoryFilter = document.getElementById('history-category-filter');
      if (historyCategoryFilter) {
        historyCategoryFilter.addEventListener('change', function() {
          console.log('History category filter changed to:', this.value);
          renderProductHistory(true); // Force refresh when filter changes
        });
      }
      
      // Populate history filter when page loads (after products are loaded)
      // This will be called by loadProductsFromServer() and the delayed initialization

      // Sales tabs removed - sales section now only shows recent sales table
      
      
      // Refresh when sales section becomes active
      var salesSection = document.getElementById('sales');
      if (salesSection) {
        // Load and render sales table when sales section becomes active
        var salesObserver = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.attributeName === 'class') {
              if (salesSection.classList.contains('active')) {
                console.log('Sales section became active, loading sales data...');
                loadManualSales().then(function() {
                  renderManualSalesTable();
                }).catch(function(error) {
                  console.error('Error loading sales for sales section:', error);
                });
              }
            }
          });
        });
        salesObserver.observe(salesSection, { attributes: true, attributeFilter: ['class'] });
        
        var observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.target.classList.contains('active')) {
              renderCharts();
              // Also render sold items when section becomes active
              var timeframe = getCurrentSalesTimeframe();
              renderSoldItems(timeframe);
            }
          });
        });
        observer.observe(salesSection, { attributes: true, attributeFilter: ['class'] });
      }

      // Add export and print functionality
      document.getElementById('export-csv-btn').addEventListener('click', function() {
        try {
          var rows = [['Product Name','Brand','Category','Stock','Retail Price','Wholesale Price']];
          products.forEach(function(product) {
            var wholesalePrice = Math.round(product.price * 0.7 * 100) / 100;
            rows.push([product.name, product.brand, product.category, product.stock, product.price, wholesalePrice]);
          });
          var wb = XLSX.utils.book_new();
          var ws = XLSX.utils.aoa_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, ws, 'Inventory');
          XLSX.writeFile(wb, 'inventory-report.xlsx');
        } catch(e) {
          alert('Export failed. Please try again.');
          console.error(e);
        }
      });


      // Customer Management
      var customers = [];

      function loadCustomersFromStore() {
        try {
          var stored = localStorage.getItem('customerOrders');
          if (!stored) {
            customers = [];
            return;
          }
          var parsed = JSON.parse(stored);
          customers = Array.isArray(parsed) ? parsed : [];
        } catch (err) {
          console.warn('Unable to parse customerOrders cache:', err);
          customers = [];
        }
      }
      loadCustomersFromStore();

      // Render customer table
      function renderCustomerTable() {
        loadCustomersFromStore();
        var tbody = document.getElementById('customers-table-tbody');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        // Flatten all customer orders into a single array
        var allOrders = [];
        customers.forEach(function(customer) {
          var orders = Array.isArray(customer.orders) ? customer.orders : [];
          orders.forEach(function(order) {
            allOrders.push({
              customerName: customer.fullName,
              orderId: order.id,
              status: order.status,
              date: order.date,
              amount: order.amount,
              products: order.products
            });
          });
        });

        // Sort by date (newest first)
        allOrders.sort(function(a, b) {
          return new Date(b.date) - new Date(a.date);
        });

        if (allOrders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#6b7280;">No orders found</td></tr>';
          return;
        }

        allOrders.forEach(function(order) {
          var row = document.createElement('tr');
          var statusClass = order.status.toLowerCase().replace(' ', '-');
          
          row.innerHTML = `
            <td>${order.customerName}</td>
            <td>${order.orderId}</td>
            <td><span class="badge ${statusClass}">${order.status.charAt(0).toUpperCase() + order.status.slice(1)}</span></td>
            <td>${order.date}</td>
            <td>‚Ç±${order.amount.toFixed(2)}</td>
            <td>${order.products}</td>
          `;
          tbody.appendChild(row);
        });
      }

      // Filter customer table
      function filterCustomerTable() {
        var searchTerm = document.getElementById('customer-table-search').value.toLowerCase();
        var rows = document.querySelectorAll('#customers-table-tbody tr');
        
        rows.forEach(function(row) {
          var customerName = row.cells[0].textContent.toLowerCase();
          var orderId = row.cells[1].textContent.toLowerCase();
          var products = row.cells[5].textContent.toLowerCase();
          
          var matches = customerName.includes(searchTerm) || 
                       orderId.includes(searchTerm) || 
                       products.includes(searchTerm);
          
          row.style.display = matches ? '' : 'none';
        });
      }

      // Customer table search functionality
      document.getElementById('customer-table-search').addEventListener('input', function() {
        filterCustomerTable();
      });

      // Export customers functionality
      document.getElementById('export-customers-btn').addEventListener('click', function() {
        try {
          var header = ['Customer Name','Order/Reservation ID','Status','Date','Amount Paid','Products'];
          var data = [header];
          var rows = document.querySelectorAll('#customers-table-tbody tr');
          rows.forEach(function(row) {
            if (row.style.display !== 'none') {
              var cells = row.cells;
              data.push([
                cells[0].textContent,
                cells[1].textContent,
                (cells[2].textContent || '').replace(/\s+/g,' ').trim(),
                cells[3].textContent,
                (cells[4].textContent || '').replace('‚Ç±',''),
                cells[5].textContent
              ]);
            }
          });
          var wb = XLSX.utils.book_new();
          var ws = XLSX.utils.aoa_to_sheet(data);
          XLSX.utils.book_append_sheet(wb, ws, 'Customers');
          XLSX.writeFile(wb, 'customers-orders.xlsx');
        } catch(e) {
          alert('Export failed. Please try again.');
          console.error(e);
        }
      });

      // Print customers functionality
      document.getElementById('print-customers-btn').addEventListener('click', function() {
        window.print();
      });

      populateProfileSection();
      gateProfileForm();

      // Initialize
      bindQuantitySteppers();
      renderInventory();
      loadReservationsFromServer(); // Load reservations from database
      renderCharts(); // Load sales data and render charts
      renderCustomerTable();
      renderProductHistory();
      renderSalesEntryGrid();
      initSalesFilters();
      loadManualSales();
      
      // Check for low stock on page load
      updateLowStockAlerts();
      
      // Also refresh when user focuses the window
      window.addEventListener('focus', function() {
        loadReservationsFromServer();
        loadProductsFromServer();
        loadManualSales();
        var salesSection = document.getElementById('sales');
        if (salesSection && salesSection.classList.contains('active')) {
          // Load and render sales table when sales section becomes active
          loadManualSales().then(function() {
            renderManualSalesTable();
          }).catch(function(error) {
            console.error('Error loading sales:', error);
          });
        }
      });
      
      // Monitor for stock changes from other tabs/windows
      window.addEventListener('storage', function(e) {
        if (e.key === 'products') {
          var savedProducts = localStorage.getItem('products');
          if (savedProducts) {
            products = JSON.parse(savedProducts);
            renderInventory();
          }
        }
        if (e.key === 'customerOrders') {
          loadCustomersFromStore();
          renderCustomerTable();
        }
      });
      
      window.addEventListener('beforeunload', function(event) {
        if (!hasUnsavedInventoryChanges) return;
        event.preventDefault();
        event.returnValue = '';
      });
      
      var sidebarNav = document.querySelector('.sidebar nav');
      if (sidebarNav) {
        sidebarNav.addEventListener('click', function(event) {
          if (!hasUnsavedInventoryChanges) return;
          var targetLink = event.target.closest('a[href^="#"]');
          if (!targetLink) return;
          if (targetLink.getAttribute('href') === '#inventory') return;
          var shouldLeave = confirm('You have unsaved inventory changes. Continue without saving?');
          if (!shouldLeave) {
            event.preventDefault();
            event.stopPropagation();
          }
        });
      }
      
      // Periodic check for low stock (every 30 seconds)
      setInterval(function() {
        updateLowStockAlerts();
      }, 30000);
      
      // Auto-refresh product history (every 30 seconds) when product history section is active
      // Reduced frequency to prevent unwanted page movement
      setInterval(function() {
        checkForNewMovements();
      }, 30000);
      
      // Initialize history when product history section is shown
      function initializeProductHistory() {
        var productHistorySection = document.getElementById('product-history');
        if (productHistorySection && productHistorySection.classList.contains('active')) {
          // Populate filter first, then render history
          populateHistoryCategoryFilter();
          renderProductHistory(true);
        }
      }
      
      // Listen for section changes to load history when tab is opened
      var sectionObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            var productHistorySection = document.getElementById('product-history');
            if (productHistorySection && productHistorySection.classList.contains('active')) {
              initializeProductHistory();
            }
          }
        });
      });
      
      var productHistorySection = document.getElementById('product-history');
      if (productHistorySection) {
        sectionObserver.observe(productHistorySection, { attributes: true });
      }
      
      // Initialize history on page load if section is active
      setTimeout(function() {
        initializeProductHistory();
      }, 1000);
      
      // ==================== SEARCH AND FILTER FUNCTIONALITY ====================
      
      // Search input handler
      // Debounce utility function for performance
      function debounce(func, wait) {
        var timeout;
        return function() {
          var context = this, args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(function() {
            func.apply(context, args);
          }, wait);
        };
      }
      
      // Throttle utility function for performance
      function throttle(func, limit) {
        var inThrottle;
        return function() {
          var args = arguments;
          var context = this;
          if (!inThrottle) {
            func.apply(context, args);
            inThrottle = true;
            setTimeout(function() {
              inThrottle = false;
            }, limit);
          }
        };
      }
      
      // Debounced render function for search
      var debouncedRenderInventory = debounce(function() {
        requestAnimationFrame(function() {
          renderInventory();
        });
      }, 300);
      
      var productSearchInput = document.getElementById('product-search');
      if (productSearchInput) {
        productSearchInput.addEventListener('input', function(e) {
          currentSearchTerm = e.target.value;
          debouncedRenderInventory();
        });
      }
      
      // Category filter handler (select dropdown) - no debounce needed for select
      var categoryFilterSelect = document.getElementById('product-category-filter');
      if (categoryFilterSelect) {
        categoryFilterSelect.addEventListener('change', function(e) {
          currentCategoryFilter = e.target.value;
          requestAnimationFrame(function() {
          renderInventory();
          });
        });
      }
      
      // Dismiss button handler
      var dismissLowStockBtn = document.getElementById('dismiss-low-stock-btn');
      if (dismissLowStockBtn) {
        dismissLowStockBtn.addEventListener('click', function() {
          dismissLowStockSection();
        });
      }
      
      // ==================== NOTIFICATION BELL FUNCTIONALITY ====================
      
      var notificationBell = document.getElementById('notification-bell');
      var notificationDropdown = document.getElementById('notification-dropdown');
      var notificationBadge = document.getElementById('notification-badge');
      var muteNotificationsBtn = document.getElementById('mute-notifications');
      var activeNotificationTab = 'low-stock';
      
      // Track muted state and checked notifications
      var notificationsMuted = localStorage.getItem('notificationsMuted') === 'true';
      var checkedNotifications = JSON.parse(localStorage.getItem('checkedNotifications') || '{}');
      
      // Initialize mute button state
      function updateMuteButton() {
        if (muteNotificationsBtn) {
          if (notificationsMuted) {
            muteNotificationsBtn.textContent = 'üîá';
            muteNotificationsBtn.title = 'Unmute notifications';
            muteNotificationsBtn.classList.add('muted');
          } else {
            muteNotificationsBtn.textContent = 'üîï';
            muteNotificationsBtn.title = 'Mute notifications';
            muteNotificationsBtn.classList.remove('muted');
          }
        }
      }
      
      // Mark notifications as checked when dropdown is opened
      function markNotificationsAsChecked() {
        var lowStockItems = getLowStockItems();
        var soldItems = getSoldItems();
        var timestamp = Date.now();
        
        // Mark low stock items as checked
        lowStockItems.forEach(function(item) {
          checkedNotifications['low-stock-' + item.id] = timestamp;
        });
        
        // Mark sold items as checked
        soldItems.forEach(function(item) {
          checkedNotifications['sold-' + item.id] = timestamp;
        });
        
        // Save to localStorage
        localStorage.setItem('checkedNotifications', JSON.stringify(checkedNotifications));
        
        // Update badge after marking as checked
        updateNotificationBadge();
      }
      
      // Check if notifications are all checked
      function areAllNotificationsChecked() {
        var lowStockItems = getLowStockItems();
        var soldItems = getSoldItems();
        
        // Check if all low stock items are checked
        var allLowStockChecked = lowStockItems.every(function(item) {
          return checkedNotifications['low-stock-' + item.id] !== undefined;
        });
        
        // Check if all sold items are checked
        var allSoldChecked = soldItems.every(function(item) {
          return checkedNotifications['sold-' + item.id] !== undefined;
        });
        
        return allLowStockChecked && allSoldChecked;
      }
      
      // Get sold items (from sales orders)
      function getSoldItems() {
        console.log('üîç getSoldItems() called');
        console.log('üîç manualSales type:', typeof manualSales);
        console.log('üîç manualSales is array?', Array.isArray(manualSales));
        console.log('üîç manualSales length:', manualSales ? manualSales.length : 'null/undefined');
        console.log('üîç manualSales content:', manualSales);
        if (!manualSales || !Array.isArray(manualSales) || manualSales.length === 0) {
          console.log('‚ö†Ô∏è No manualSales data available or empty array');
          return [];
        }
        // Return last 10 sales orders, sorted by date (newest first)
        var sorted = manualSales
          .filter(function(sale) {
            // Filter out any invalid entries
            return sale && (sale.id || sale.order_number);
          })
          .sort(function(a, b) {
            var dateA = new Date(a.ordered_at || a.orderedAt || 0);
            var dateB = new Date(b.ordered_at || b.orderedAt || 0);
            return dateB - dateA;
          })
          .slice(0, 10);
        console.log('‚úÖ getSoldItems() returning:', sorted.length, 'items');
        if (sorted.length > 0) {
          console.log('‚úÖ First sorted item:', sorted[0]);
        }
        return sorted;
      }

      // ===== Sales filters UI wiring =====
      function initSalesFilters() {
        if (!salesTimeframeFilter || !salesMonthFilter || !salesYearFilter) {
          return;
        }

        var now = new Date();
        salesMonthFilter.value = String(now.getMonth() + 1);
        salesYearFilter.value = String(now.getFullYear());

        function updateVisibility() {
          var timeframe = salesTimeframeFilter.value;
          if (timeframe === 'monthly') {
            salesMonthFilter.style.display = '';
            salesYearFilter.style.display = '';
          } else if (timeframe === 'yearly') {
            salesMonthFilter.style.display = 'none';
            salesYearFilter.style.display = '';
          } else {
            salesMonthFilter.style.display = 'none';
            salesYearFilter.style.display = 'none';
          }
        }

        updateVisibility();

        salesTimeframeFilter.addEventListener('change', function() {
          updateVisibility();
          refreshSalesSummary();
        });
        salesMonthFilter.addEventListener('change', refreshSalesSummary);
        salesYearFilter.addEventListener('change', refreshSalesSummary);
        if (salesCategoryFilter) {
          salesCategoryFilter.addEventListener('change', refreshSalesSummary);

          // Populate category dropdown with only specific allowed categories for Sales
          var allowedSalesCategories = [
            'Home & Furniture',
            'Kitchenware & Tableware',
            'Electronics & Appliances',
            'Fashion & Accessories (Ukay-Ukay)',
            'Miscellaneous'
          ];
          
          fetch(API_BASE_URL + '/api/categories')
            .then(function(response) { return response.json(); })
            .then(function(categories) {
              salesCategoryFilter.innerHTML = '<option value=\"\">All Categories</option>';
              (categories || []).forEach(function(cat) {
                if (!cat || !cat.name) return;
                // Only add categories that are in the allowed list
                if (allowedSalesCategories.includes(cat.name)) {
                  var opt = document.createElement('option');
                  opt.value = cat.name; // use category name, same pattern as inventory filters
                  opt.textContent = cat.name;
                  salesCategoryFilter.appendChild(opt);
                }
              });
            })
            .catch(function(err) {
              console.error('Error loading sales categories:', err);
            });
        }
      }
      
      // Update notification badge
      function updateNotificationBadge() {
        if (!notificationBadge) return;
        
        // Don't show badge if muted
        if (notificationsMuted) {
          notificationBadge.style.display = 'none';
          return;
        }
        
        // Count unchecked notifications
        var lowStockItems = getLowStockItems();
        var soldItems = getSoldItems();
        
        var uncheckedLowStock = lowStockItems.filter(function(item) {
          return !checkedNotifications['low-stock-' + item.id];
        }).length;
        
        var uncheckedSold = soldItems.filter(function(item) {
          return !checkedNotifications['sold-' + item.id];
        }).length;
        
        var totalUnchecked = uncheckedLowStock + uncheckedSold;
        
        if (totalUnchecked > 0) {
          notificationBadge.textContent = totalUnchecked > 99 ? '99+' : totalUnchecked;
          notificationBadge.style.display = 'inline-block';
        } else {
          notificationBadge.style.display = 'none';
        }
      }
      
      // Render notification content
      function renderNotificationContent(tab) {
        var content = document.getElementById('notification-content');
        if (!content) return;
        
        if (tab === 'low-stock') {
          var lowStockItems = getLowStockItems();
          if (lowStockItems.length === 0) {
            content.innerHTML = '<div class="notification-empty" style="padding: 16px; text-align: center; color: #6b7280;">No low stock items</div>';
          } else {
            content.innerHTML = lowStockItems.map(function(product) {
              var productImage = resolveProductImage(product.image);
              return `
                <div class="notification-item">
                  <img src="${productImage}" alt="${product.name}" class="notification-item-image" onerror="this.onerror=null;this.src='${DEFAULT_PRODUCT_IMAGE}';">
                  <div class="notification-item-content">
                    <div class="notification-item-title">${product.name}</div>
                    <div class="notification-item-details">${product.brand} ‚Ä¢ ${product.category}</div>
                    <div class="notification-item-meta">Stock: ${product.stock} (Low)</div>
                  </div>
                </div>
              `;
            }).join('');
          }
        } else if (tab === 'sold') {
          console.log('üìã Rendering sold items tab, manualSales:', manualSales);
          var soldItems = getSoldItems();
          console.log('üìã Sold items to display:', soldItems.length, soldItems);
          if (soldItems.length === 0) {
            console.log('‚ö†Ô∏è No sold items to display');
            content.innerHTML = '<div class="notification-empty" style="padding: 16px; text-align: center; color: #6b7280;">No recent sold items</div>';
          } else {
            content.innerHTML = soldItems.map(function(sale, index) {
              console.log('üé® Rendering sale item:', sale);
              // Get first product from items array, or use default
              var firstItem = sale.items && sale.items.length > 0 ? sale.items[0] : null;
              var productName = firstItem ? firstItem.product_name : (sale.order_number || 'Sale #' + sale.id);
              var productId = firstItem ? firstItem.product_id : null;
              
              // Get product image from products array
              var productImage = DEFAULT_PRODUCT_IMAGE;
              if (productId && products && products.length > 0) {
                var product = products.find(function(p) {
                  var numericId = p.id.toString().startsWith('p') ? p.id.toString().substring(1) : p.id;
                  return numericId == productId;
                });
                if (product) {
                  productImage = resolveProductImage(product.image);
                }
              }
              
              var customerName = sale.customer_name || 'Walk-in Customer';
              var date = sale.ordered_at ? new Date(sale.ordered_at).toLocaleDateString() : 'N/A';
              var totalAmount = sale.total_amount ? parseFloat(sale.total_amount).toFixed(2) : '0.00';
              
              // If no product name from items, show order number
              if (!firstItem) {
                productName = 'Order ' + (sale.order_number || sale.id);
              }
              
              return `
                <div class="notification-item">
                  <img src="${productImage}" alt="${productName}" class="notification-item-image" onerror="this.onerror=null;this.src='${DEFAULT_PRODUCT_IMAGE}';">
                  <div class="notification-item-content">
                    <div class="notification-item-title">${productName}</div>
                    <div class="notification-item-details">Sold to: ${customerName}</div>
                    <div class="notification-item-meta">‚Ç±${totalAmount} ‚Ä¢ ${date}</div>
                  </div>
                </div>
                ${index < soldItems.length - 1 ? '<div class="notification-item-divider"></div>' : ''}
              `;
            }).join('');
          }
        }
      }
      
      // Toggle notification dropdown
      if (notificationBell && notificationDropdown) {
        notificationBell.addEventListener('click', function(e) {
          e.stopPropagation();
          var isVisible = notificationDropdown.style.display === 'block';
          notificationDropdown.style.display = isVisible ? 'none' : 'block';
          // Always ensure sales are loaded before rendering
          console.log('üîî Notification bell clicked, isVisible:', isVisible);
          if (!isVisible) {
            // Opening dropdown - load sales first
            console.log('üîî Opening notification dropdown, loading sales...');
            loadManualSales().then(function(sales) {
              console.log('üîî Sales loaded after bell click:', sales.length);
              console.log('üîî Rendering content for tab:', activeNotificationTab);
              renderNotificationContent(activeNotificationTab);
              // Mark notifications as checked when dropdown is opened
              markNotificationsAsChecked();
            }).catch(function(error) {
              console.error('üîî Error loading sales on bell click:', error);
              renderNotificationContent(activeNotificationTab);
              // Still mark as checked even if there's an error
              markNotificationsAsChecked();
            });
          }
        });
        
        // Mute notifications button
        if (muteNotificationsBtn) {
          updateMuteButton(); // Initialize button state
          muteNotificationsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            notificationsMuted = !notificationsMuted;
            localStorage.setItem('notificationsMuted', notificationsMuted.toString());
            updateMuteButton();
            updateNotificationBadge();
          });
        }
        
        // Close notifications button
        var closeNotificationsBtn = document.getElementById('close-notifications');
        if (closeNotificationsBtn) {
          closeNotificationsBtn.addEventListener('click', function() {
            notificationDropdown.style.display = 'none';
          });
        }
        
        // Notification tabs
        var notificationTabs = document.querySelectorAll('.notification-tab');
        notificationTabs.forEach(function(tab) {
          tab.addEventListener('click', function() {
            notificationTabs.forEach(function(t) { t.classList.remove('active'); });
            tab.classList.add('active');
            activeNotificationTab = tab.getAttribute('data-tab');
            // Ensure sales are loaded before rendering sold items
            if (activeNotificationTab === 'sold') {
              console.log('üìã Sold Items tab clicked, loading sales...');
              console.log('üìã Current manualSales before load:', manualSales.length);
              loadManualSales().then(function(sales) {
                console.log('üìã Sales loaded for Sold Items tab:', sales.length);
                console.log('üìã manualSales after load:', manualSales.length);
                console.log('üìã Sales data:', sales);
                renderNotificationContent(activeNotificationTab);
                // Mark notifications as checked when tab is viewed
                markNotificationsAsChecked();
              }).catch(function(error) {
                console.error('‚ùå Error loading sales for Sold Items tab:', error);
                console.error('‚ùå Error details:', error.message);
                // Still render even if there's an error, so user sees the error state
                renderNotificationContent(activeNotificationTab);
                // Still mark as checked
                markNotificationsAsChecked();
              });
            } else {
              renderNotificationContent(activeNotificationTab);
              // Mark notifications as checked when tab is viewed
              markNotificationsAsChecked();
            }
          });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
          if (!notificationBell.contains(e.target) && !notificationDropdown.contains(e.target)) {
            notificationDropdown.style.display = 'none';
          }
        });
      }
      
      // Update notifications when reservations are loaded
      var originalLoadReservations = loadReservationsFromServer;
      loadReservationsFromServer = function() {
        return originalLoadReservations().then(function() {
          updateNotificationBadge();
          if (notificationDropdown && notificationDropdown.style.display === 'block') {
            renderNotificationContent(activeNotificationTab);
          }
          // Update sold items list if sales section is active
          var salesSection = document.getElementById('sales');
          if (salesSection && salesSection.classList.contains('active')) {
            var timeframe = getCurrentSalesTimeframe();
            renderSoldItems(timeframe);
          }
          return reservations;
        });
      };
      
      // Initialize mute button on page load
      updateMuteButton();
      
      // Load reservations and sales on page load for notifications
      setTimeout(function() {
        console.log('üöÄ Page load: Starting to load sales data...');
        loadReservationsFromServer().then(function() {
          updateNotificationBadge();
        });
        loadManualSales().then(function(sales) {
          console.log('üì¶ Initial sales load on page:', sales.length, 'sales loaded');
          console.log('üì¶ manualSales variable after load:', manualSales.length);
          updateNotificationBadge();
        }).catch(function(error) {
          console.error('‚ùå Failed to load sales on page load:', error);
          console.error('‚ùå Error stack:', error.stack);
          // Set to empty array on error
          manualSales = [];
          updateNotificationBadge();
        });
      }, 500);

      // ==================== REAL-TIME UPDATES (WebSocket) ====================
      var socket = null;
      var API_BASE_URL_WS = API_BASE_URL.replace(/\/+$/, '');
      
      // Initialize WebSocket connection
      function initWebSocket() {
        try {
          socket = io(API_BASE_URL_WS, {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5
          });
          
          socket.on('connect', function() {
            console.log('üîå Connected to real-time server');
            // Join admin room
            if (currentUser && currentUser.role) {
              socket.emit('join-room', 'admin');
            }
          });
          
          socket.on('disconnect', function() {
            console.log('üîå Disconnected from real-time server');
          });
          
          socket.on('connect_error', function(error) {
            console.warn('‚ö†Ô∏è WebSocket connection error:', error);
          });
          
          // Listen for inventory updates
          socket.on('inventory:updated', function() {
            console.log('üì¶ Inventory updated - refreshing...');
            loadProductsFromServer();
            updateLowStockAlerts();
          });
          
          // Listen for product updates
          socket.on('product:created', function(data) {
            console.log('‚ûï New product created:', data);
            loadProductsFromServer();
          });
          
          socket.on('product:updated', function(data) {
            console.log('‚úèÔ∏è Product updated:', data);
            loadProductsFromServer();
          });
          
          socket.on('product:deleted', function(data) {
            console.log('üóëÔ∏è Product deleted:', data);
            loadProductsFromServer();
          });
          
          socket.on('product:stock-changed', function(data) {
            console.log('üìä Stock changed:', data);
            loadProductsFromServer();
          });
          
          // Listen for reservation updates
          socket.on('reservations:updated', function() {
            console.log('üìã Reservations updated - refreshing...');
            loadReservationsFromServer();
          });
          
          socket.on('reservation:created', function(data) {
            console.log('‚ú® New reservation created:', data);
            loadReservationsFromServer();
            updateLowStockAlerts();
          });
          
          socket.on('reservation:status-changed', function(data) {
            console.log('üîÑ Reservation status changed:', data);
            loadReservationsFromServer();
          });
          
          // Listen for sales updates
          socket.on('sales:updated', function() {
            console.log('üìä Sales updated - refreshing sales data...');
            loadManualSales().then(function() {
              updateSalesTodayCount();
            }).catch(function(error) {
              console.error('Error refreshing sales:', error);
            });
            console.log('üí∞ Sales updated - refreshing charts...');
            loadManualSales().then(function() {
              updateNotificationBadge();
              // Refresh notification content if dropdown is open and sold tab is active
              if (notificationDropdown && notificationDropdown.style.display === 'block' && activeNotificationTab === 'sold') {
                renderNotificationContent('sold');
              }
            });
            var salesSection = document.getElementById('sales');
            if (salesSection && salesSection.classList.contains('active')) {
              renderCharts();
            }
          });
          
          // Listen for inventory movement updates
          socket.on('inventory:movement-created', function(data) {
            console.log('üìù Inventory movement created:', data);
            renderProductHistory();
          });
          
          // Listen for customer updates
          socket.on('customer:updated', function(data) {
            console.log('üë§ Customer updated:', data);
            renderCustomerTable();
          });
          
        } catch (error) {
          console.error('Failed to initialize WebSocket:', error);
        }
      }
      
      // Initialize WebSocket on page load
      if (typeof io !== 'undefined') {
        initWebSocket();
      } else {
        console.warn('‚ö†Ô∏è Socket.io not loaded, real-time updates disabled');
      }
      
      // Enhanced polling with optimized intervals (fallback if WebSocket fails)
      // Auto-refresh reservations every 60 seconds (optimized to reduce server load)
      setInterval(function() {
        if (document.getElementById('reservations') && document.getElementById('reservations').classList.contains('active')) {
        loadReservationsFromServer();
        }
      }, 60000);
      
      // Auto-refresh sales data every 90 seconds when active (optimized to reduce server load)
      setInterval(function() {
        if (document.getElementById('sales') && document.getElementById('sales').classList.contains('active')) {
          loadManualSales().then(function() {
            requestAnimationFrame(function() {
            renderManualSalesTable();
            });
          }).catch(function(error) {
            console.error('Error refreshing sales:', error);
          });
        }
      }, 90000);
      
      // Auto-refresh inventory every 60 seconds when active (optimized to reduce server load)
      setInterval(function() {
        if (document.getElementById('inventory') && document.getElementById('inventory').classList.contains('active')) {
          loadProductsFromServer();
        }
      }, 60000);

    })();
  </script>
</body>
</html>
